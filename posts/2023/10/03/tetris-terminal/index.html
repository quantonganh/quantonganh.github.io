
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Learning Rust by building Tetris: my favorite childhood game</title>
  <meta name="description"
    content="DevOps - Programming - Travel - Photography">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
    integrity="sha384-tKLJeE1ALTUwtXlaGjJYM3sejfssWdAaWR2s97axw4xkiAdMzQjtOjgcyw0Y50KU" crossorigin="anonymous">
  <link rel="stylesheet" href="/static/css/index.css">
  <link rel="stylesheet" href="/static/css/basic.css">
  <link rel="stylesheet" href="/static/css/grid.css">

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"
    integrity="sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"
    integrity="sha384-YnGSHPPWEUDKMHFPOVmNP7Xyfwx5G0CHet6IoNgiX6CbFZS8gCeIfEgB1MgPwjdI"
    crossorigin="anonymous"></script>
</head>

<body class="d-flex flex-column min-vh-100">
  <article>
    <header class="text-center">
      <div class="title">
        <a href="/">
          <img class="quanface" src="/static/images/quanface.png" />
          Quan Tong
        </a>
      </div>
      <i>"Life is all about sharing. If we are good at something, pass it on." - Mary Berry</i>
      <div class="navi">
        <ul>
          <li>
            <a href="/about">About</a>
          </li>
          <li>
            <a href="/projects">Projects</a>
          </li>
          <li>
            <a href="/photos">Photos</a>
          </li>
          <li>
            <a class="dropdown-toggle" href="#" role="button" id="categoriesMenuLink" data-toggle="dropdown"
              aria-haspopup="true" aria-expanded="false">
              Categories
            </a>

            <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
              
              <a class="dropdown-item" href="/categories/Cu%e1%bb%99c%20s%e1%bb%91ng">Cuộc sống (12)</a>
              
              <a class="dropdown-item" href="/categories/DevOps">DevOps (19)</a>
              
              <a class="dropdown-item" href="/categories/Development%20Environment">Development Environment (15)</a>
              
              <a class="dropdown-item" href="/categories/Du%20l%e1%bb%8bch">Du lịch (11)</a>
              
              <a class="dropdown-item" href="/categories/Networking">Networking (4)</a>
              
              <a class="dropdown-item" href="/categories/Operating%20System">Operating System (1)</a>
              
              <a class="dropdown-item" href="/categories/Programming">Programming (30)</a>
              
            </div>
          </li>
          <li>
            <a href="/tags">Tags</a>
          </li>
          <li>
            <a href="/search">
              <i class="bi bi-search"></i> Search
            </a>
          </li>
        </ul>
      </div>
    </header>
    <hr>
    
<article data-pagefind-body>
  <h3>Learning Rust by building Tetris: my favorite childhood game</h3>
  <p class="text-secondary">2023-10-03</p>
  <p><img src="tetris-2-player.gif" alt="Play tetris 2-player mode in the terminal" /></p>

<p>After completing the <a href="https://doc.rust-lang.org/book/">Rust book</a> and working through <a href="https://github.com/rust-lang/rustlings">rustlings</a>, I found myself standing at the crossroads, wondering where to go next. It was then that I had an idea - a project that would allow me to apply my newfound knowledge and create something meaningful. My favorite childhood game, Tetris, became the inspiration for my next coding adventure.</p>

<p>Since I want it to be playable on Windows, I chose the TUI library <a href="https://github.com/crossterm-rs/crossterm">crossterm</a>.</p>

<ol>
<li><a href="#drawing-borders-and-playfield">Drawing borders and the playfield</a></li>
<li><a href="#drawing-tetrominoes">Drawing tetrominoes</a></li>
<li><a href="#automatic-and-soft-drop">Automatic and soft drop</a></li>
<li><a href="#lock-tetromino-and-move-to-next">Lock tetromino and move to the next</a></li>
<li><a href="#handling-key-events">Handling key events</a></li>
<li><a href="#clearing-filled-lines">Clearing the filled lines</a></li>
<li><a href="#game-over">Game over</a></li>
<li><a href="#pause-and-quit">Pause and Quit</a></li>
<li><a href="#reset">Reset</a></li>
<li><a href="#multiplayer-mode">Multiplayer mode</a></li>
</ol>

<h4 id="drawing-borders-and-playfield">1. Drawing borders and playfield</h4>

<p>The initial step is to draw the borders. The standard Tetris playing field has 20 rows and 10 columns. I&rsquo;ve designated the pipe operator (<code>|</code>) for the left and right borders and a dash (<code>-</code>) for the top and bottom borders:</p>

<p>The function takes input in the form of coordinates, width and height parameters representing the playing field:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">render_frame</span>(
</span></span><span style="display:flex;"><span>    stdout: <span style="color:#cc7832">&amp;</span>mut io::Stdout,
</span></span><span style="display:flex;"><span>    title: <span style="color:#cc7832">&amp;</span><span style="color:#cc7832">str</span>,
</span></span><span style="display:flex;"><span>    start_x: <span style="color:#cc7832">usize</span>,
</span></span><span style="display:flex;"><span>    start_y: <span style="color:#cc7832">usize</span>,
</span></span><span style="display:flex;"><span>    width: <span style="color:#cc7832">usize</span>,
</span></span><span style="display:flex;"><span>    height: <span style="color:#cc7832">usize</span>,
</span></span><span style="display:flex;"><span>) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#ffc66d">execute!</span>(
</span></span><span style="display:flex;"><span>        stdout,
</span></span><span style="display:flex;"><span>        SetForegroundColor(Color::White),
</span></span><span style="display:flex;"><span>        SetBackgroundColor(Color::Black),
</span></span><span style="display:flex;"><span>    )?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#808080">// Print the top border
</span></span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> left = (width - title.len() - <span style="color:#6897bb">2</span>) / <span style="color:#6897bb">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ffc66d">execute!</span>(
</span></span><span style="display:flex;"><span>        stdout,
</span></span><span style="display:flex;"><span>        MoveTo(start_x <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>, start_y <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>),
</span></span><span style="display:flex;"><span>        Print(<span style="color:#ffc66d">format!</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">|</span><span style="color:#6a8759">{}</span><span style="color:#6a8759"> </span><span style="color:#6a8759">{}</span><span style="color:#6a8759"> </span><span style="color:#6a8759">{}</span><span style="color:#6a8759">|</span><span style="color:#6a8759">&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">-</span><span style="color:#6a8759">&#34;</span>.repeat(left <span style="color:#cc7832">as</span> <span style="color:#cc7832">usize</span>),
</span></span><span style="display:flex;"><span>            title,
</span></span><span style="display:flex;"><span>            <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">-</span><span style="color:#6a8759">&#34;</span>.repeat(width <span style="color:#cc7832">as</span> <span style="color:#cc7832">usize</span> - left <span style="color:#cc7832">as</span> <span style="color:#cc7832">usize</span> - title.len() - <span style="color:#6897bb">2</span>)
</span></span><span style="display:flex;"><span>        )),
</span></span><span style="display:flex;"><span>    )?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#808080">// Print the left and right borders
</span></span></span><span style="display:flex;"><span>    <span style="color:#cc7832">for</span> index <span style="color:#cc7832">in</span> <span style="color:#6897bb">1</span>..height {
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">execute!</span>(
</span></span><span style="display:flex;"><span>            stdout,
</span></span><span style="display:flex;"><span>            MoveTo(start_x <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>, start_y <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + index <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>),
</span></span><span style="display:flex;"><span>            Print(<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">|</span><span style="color:#6a8759">&#34;</span>),
</span></span><span style="display:flex;"><span>            MoveTo(
</span></span><span style="display:flex;"><span>                start_x <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + width <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">1</span>,
</span></span><span style="display:flex;"><span>                start_y <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + index <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>            Print(<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">|</span><span style="color:#6a8759">&#34;</span>),
</span></span><span style="display:flex;"><span>        )?;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#808080">// Print the bottom border
</span></span></span><span style="display:flex;"><span>    <span style="color:#ffc66d">execute!</span>(
</span></span><span style="display:flex;"><span>        stdout,
</span></span><span style="display:flex;"><span>        MoveTo(start_x <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>, start_y <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + height <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>),
</span></span><span style="display:flex;"><span>        Print(<span style="color:#ffc66d">format!</span>(<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">|</span><span style="color:#6a8759">{}</span><span style="color:#6a8759">|</span><span style="color:#6a8759">&#34;</span>, (<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">-</span><span style="color:#6a8759">&#34;</span>).repeat(width <span style="color:#cc7832">as</span> <span style="color:#cc7832">usize</span>))),
</span></span><span style="display:flex;"><span>    )?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    stdout.flush()?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<p>the borders can be rendered as:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">const</span> <span style="color:#9876aa">PLAY_WIDTH</span>: <span style="color:#cc7832">usize</span> = <span style="color:#6897bb">10</span>;
</span></span><span style="display:flex;"><span><span style="color:#cc7832">const</span> <span style="color:#9876aa">PLAY_HEIGHT</span>: <span style="color:#cc7832">usize</span> = <span style="color:#6897bb">20</span>;
</span></span><span style="display:flex;"><span><span style="color:#cc7832">const</span> <span style="color:#9876aa">SQUARE_BRACKETS</span>: <span style="color:#cc7832">&amp;</span><span style="color:#cc7832">str</span> = <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">[ ]</span><span style="color:#6a8759">&#34;</span>;
</span></span></code></pre><pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span>render_frame(
</span></span><span style="display:flex;"><span>    stdout,
</span></span><span style="display:flex;"><span>    <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">Tetris</span><span style="color:#6a8759">&#34;</span>,
</span></span><span style="display:flex;"><span>    self.start_x,
</span></span><span style="display:flex;"><span>    self.start_y,
</span></span><span style="display:flex;"><span>    <span style="color:#9876aa">PLAY_WIDTH</span> * <span style="color:#6897bb">3</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#9876aa">PLAY_HEIGHT</span> + <span style="color:#6897bb">1</span>,
</span></span><span style="display:flex;"><span>)?;
</span></span></code></pre>
<p>As I use square brackets to make up the tetromino, we need to multiply <code>PLAY_WIDTH</code> by 3:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">create_grid</span>(
</span></span><span style="display:flex;"><span>    width: <span style="color:#cc7832">usize</span>,
</span></span><span style="display:flex;"><span>    height: <span style="color:#cc7832">usize</span>,
</span></span><span style="display:flex;"><span>) -&gt; Vec&lt;Vec&lt;Cell&gt;&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> grid = <span style="color:#ffc66d">vec!</span>[<span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>; width]; height];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    grid
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">let</span> play_grid = create_grid(<span style="color:#9876aa">PLAY_WIDTH</span>, <span style="color:#9876aa">PLAY_HEIGHT</span>);
</span></span></code></pre>
<h4 id="drawing-tetrominoes">2. Drawing Tetrominoes</h4>

<p>A tetromino can be represented as:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">struct</span> Tetromino {
</span></span><span style="display:flex;"><span>    states: Vec&lt;Vec&lt;Vec&lt;Cell&gt;&gt;&gt;,
</span></span><span style="display:flex;"><span>    current_state: <span style="color:#cc7832">usize</span>,
</span></span><span style="display:flex;"><span>    position: Position,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">const</span> <span style="color:#9876aa">I_CELL</span>: Cell = Cell {
</span></span><span style="display:flex;"><span>    symbols: SQUARE_BRACKETS,
</span></span><span style="display:flex;"><span>    color: Color::Cyan,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre><pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">let</span> i_tetromino_states: Vec&lt;Vec&lt;Vec&lt;Cell&gt;&gt;&gt; = <span style="color:#ffc66d">vec!</span>[
</span></span><span style="display:flex;"><span>    <span style="color:#ffc66d">vec!</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">I_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#ffc66d">vec!</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#ffc66d">vec!</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">I_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#ffc66d">vec!</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>];
</span></span></code></pre>
<p>To draw a tetromino, we just need to loop through the its current state, and draw each cell with corresponding color:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">render_current_tetromino</span>(&amp;self, stdout: <span style="color:#cc7832">&amp;</span>mut std::io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> current_tetromino = &amp;self.current_tetromino;
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">for</span> (row_index, row) <span style="color:#cc7832">in</span> current_tetromino.states[current_tetromino.current_state]
</span></span><span style="display:flex;"><span>        .iter()
</span></span><span style="display:flex;"><span>        .enumerate()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">for</span> (col_index, &amp;<span style="color:#cc7832">ref</span> cell) <span style="color:#cc7832">in</span> row.iter().enumerate() {
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">let</span> grid_x = current_tetromino.position.col + col_index <span style="color:#cc7832">as</span> <span style="color:#cc7832">isize</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">let</span> grid_y = current_tetromino.position.row + row_index <span style="color:#cc7832">as</span> <span style="color:#cc7832">isize</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">if</span> cell.symbols != <span style="color:#9876aa">SPACE</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">if</span> grid_x &lt; <span style="color:#9876aa">PLAY_WIDTH</span> <span style="color:#cc7832">as</span> <span style="color:#cc7832">isize</span> &amp;&amp; grid_y &lt; <span style="color:#9876aa">PLAY_HEIGHT</span> <span style="color:#cc7832">as</span> <span style="color:#cc7832">isize</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#ffc66d">execute!</span>(
</span></span><span style="display:flex;"><span>                        stdout,
</span></span><span style="display:flex;"><span>                        SavePosition,
</span></span><span style="display:flex;"><span>                        MoveTo(
</span></span><span style="display:flex;"><span>                            self.start_x <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">1</span> + grid_x <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> * <span style="color:#9876aa">CELL_WIDTH</span> <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>,
</span></span><span style="display:flex;"><span>                            self.start_y <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">1</span> + grid_y <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>
</span></span><span style="display:flex;"><span>                        ),
</span></span><span style="display:flex;"><span>                        SetForegroundColor(cell.color),
</span></span><span style="display:flex;"><span>                        SetBackgroundColor(Color::Black),
</span></span><span style="display:flex;"><span>                        Print(cell.symbols),
</span></span><span style="display:flex;"><span>                        ResetColor,
</span></span><span style="display:flex;"><span>                        RestorePosition,
</span></span><span style="display:flex;"><span>                    )?;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<h4 id="automatic-and-soft-drop">3. Automatic and soft drop</h4>

<h5>3.1 Automatic drop</h5>

<p>First, we need to write a function to detect the collision. To do this, we need to check if the new column / row (after moving) goes outside of the playfield, or if that cell is already occupied:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">can_move</span>(&amp;<span style="color:#cc7832">mut</span> self, tetromino: <span style="color:#cc7832">&amp;</span>Tetromino, new_row: <span style="color:#cc7832">i16</span>, new_col: <span style="color:#cc7832">i16</span>) -&gt; <span style="color:#cc7832">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">for</span> (t_row, row) <span style="color:#cc7832">in</span> tetromino.get_cells().iter().enumerate() {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">for</span> (t_col, &amp;<span style="color:#cc7832">ref</span> cell) <span style="color:#cc7832">in</span> row.iter().enumerate() {
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">if</span> cell.symbols == <span style="color:#9876aa">SQUARE_BRACKETS</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> grid_x = new_col + t_col <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> grid_y = new_row + t_row <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">if</span> grid_x &lt; <span style="color:#6897bb">0</span>
</span></span><span style="display:flex;"><span>                    || grid_x &gt;= <span style="color:#9876aa">PLAY_WIDTH</span> <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>
</span></span><span style="display:flex;"><span>                    || grid_y &gt;= <span style="color:#9876aa">PLAY_HEIGHT</span> <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>
</span></span><span style="display:flex;"><span>                    || self.play_grid[grid_y <span style="color:#cc7832">as</span> <span style="color:#cc7832">usize</span>][grid_x <span style="color:#cc7832">as</span> <span style="color:#cc7832">usize</span>].symbols
</span></span><span style="display:flex;"><span>                        == <span style="color:#9876aa">SQUARE_BRACKETS</span>
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#cc7832">return</span> <span style="color:#cc7832">false</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<p>At a regular interval, we will check if a tetromino can be moved down, and if so, we will increase the row by 1, clear the old tetromino and draw a new one:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> drop_timer = Instant::now();
</span></span><span style="display:flex;"><span><span style="color:#cc7832">if</span> drop_timer.elapsed() &gt;= Duration::from_millis(self.drop_interval) {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> tetromino = self.current_tetromino.clone();
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> can_move_down = self.can_move(
</span></span><span style="display:flex;"><span>        &amp;tetromino,
</span></span><span style="display:flex;"><span>        tetromino.position.row <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span> + <span style="color:#6897bb">1</span>,
</span></span><span style="display:flex;"><span>        tetromino.position.col <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>,
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">if</span> can_move_down {
</span></span><span style="display:flex;"><span>        tetromino.move_down(self, stdout)?;
</span></span><span style="display:flex;"><span>        self.current_tetromino = tetromino;
</span></span><span style="display:flex;"><span>    } <span style="color:#cc7832">else</span> {
</span></span><span style="display:flex;"><span>        self.lock_and_move_to_next(&amp;tetromino, stdout)?;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    self.render_current_tetromino(stdout)?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    drop_timer = Instant::now();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">move_down</span>(&amp;<span style="color:#cc7832">mut</span> self, game: <span style="color:#cc7832">&amp;</span>mut Game, stdout: <span style="color:#cc7832">&amp;</span>mut std::io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">if</span> game.can_move(self, self.position.row <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span> + <span style="color:#6897bb">1</span>, self.position.col <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>) {
</span></span><span style="display:flex;"><span>        game.clear_tetromino(stdout)?;
</span></span><span style="display:flex;"><span>        self.position.row += <span style="color:#6897bb">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<p>To clear the old tetromino, we just need to draw an empty cell:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">clear_tetromino</span>(&amp;<span style="color:#cc7832">mut</span> self, stdout: <span style="color:#cc7832">&amp;</span>mut std::io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> tetromino = &amp;self.current_tetromino;
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">for</span> (row_index, row) <span style="color:#cc7832">in</span> tetromino.states[tetromino.current_state].iter().enumerate() {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">for</span> (col_index, &amp;<span style="color:#cc7832">ref</span> cell) <span style="color:#cc7832">in</span> row.iter().enumerate() {
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">let</span> grid_x = tetromino.position.col + col_index <span style="color:#cc7832">as</span> <span style="color:#cc7832">isize</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">let</span> grid_y = tetromino.position.row + row_index <span style="color:#cc7832">as</span> <span style="color:#cc7832">isize</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">if</span> cell.symbols != <span style="color:#9876aa">SPACE</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#ffc66d">execute!</span>(
</span></span><span style="display:flex;"><span>                    stdout,
</span></span><span style="display:flex;"><span>                    SetBackgroundColor(Color::Black),
</span></span><span style="display:flex;"><span>                    SavePosition,
</span></span><span style="display:flex;"><span>                    MoveTo(
</span></span><span style="display:flex;"><span>                        self.start_x <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">1</span> + grid_x <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> * <span style="color:#9876aa">CELL_WIDTH</span> <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>,
</span></span><span style="display:flex;"><span>                        self.start_y <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">1</span> + grid_y <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>,
</span></span><span style="display:flex;"><span>                    ),
</span></span><span style="display:flex;"><span>                    Print(<span style="color:#9876aa">SPACE</span>),
</span></span><span style="display:flex;"><span>                    ResetColor,
</span></span><span style="display:flex;"><span>                    RestorePosition
</span></span><span style="display:flex;"><span>                )?;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<h5 id="soft-drop">3.2. Soft drop</h5>

<p>At the starting levels, we may need a way to make the tetromino drop faster than the regular interval. That&rsquo;s when the soft drop comes into play.</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">if</span> kind == KeyEventKind::Press {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> tetromino = self.current_tetromino.clone();
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">match</span> code {
</span></span><span style="display:flex;"><span>        KeyCode::Char(<span style="color:#6a8759">&#39;s&#39;</span>) | KeyCode::Up =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">if</span> soft_drop_timer.elapsed()
</span></span><span style="display:flex;"><span>                &gt;= (Duration::from_millis(self.drop_interval / <span style="color:#6897bb">8</span>))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> tetromino = self.current_tetromino.clone();
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">if</span> self.can_move(
</span></span><span style="display:flex;"><span>                    &amp;tetromino,
</span></span><span style="display:flex;"><span>                    tetromino.position.row <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span> + <span style="color:#6897bb">1</span>,
</span></span><span style="display:flex;"><span>                    tetromino.position.col <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>,
</span></span><span style="display:flex;"><span>                ) {
</span></span><span style="display:flex;"><span>                    tetromino.move_down(self, stdout)?;
</span></span><span style="display:flex;"><span>                    self.current_tetromino = tetromino;
</span></span><span style="display:flex;"><span>                } <span style="color:#cc7832">else</span> {
</span></span><span style="display:flex;"><span>                    self.lock_and_move_to_next(&amp;tetromino, stdout)?;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                soft_drop_timer = Instant::now();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span></code></pre>
<h4 id="lock-tetromino-and-move-to-next">4. Lock tetromino and move the next</h4>

<p>When a tetromino reaches the bottom, we need to lock it at that position and move on to the next one:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">lock_and_move_to_next</span>(
</span></span><span style="display:flex;"><span>    &amp;<span style="color:#cc7832">mut</span> self,
</span></span><span style="display:flex;"><span>    tetromino: <span style="color:#cc7832">&amp;</span>Tetromino,
</span></span><span style="display:flex;"><span>    stdout: <span style="color:#cc7832">&amp;</span>mut io::Stdout,
</span></span><span style="display:flex;"><span>) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    self.lock_tetromino(tetromino, stdout)?;
</span></span><span style="display:flex;"><span>    self.move_to_next(stdout)?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">lock_tetromino</span>(&amp;<span style="color:#cc7832">mut</span> self, tetromino: <span style="color:#cc7832">&amp;</span>Tetromino, stdout: <span style="color:#cc7832">&amp;</span>mut io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">for</span> (ty, row) <span style="color:#cc7832">in</span> tetromino.get_cells().iter().enumerate() {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">for</span> (tx, &amp;<span style="color:#cc7832">ref</span> cell) <span style="color:#cc7832">in</span> row.iter().enumerate() {
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">if</span> cell.symbols == <span style="color:#9876aa">SQUARE_BRACKETS</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> grid_x = (tetromino.position.col <span style="color:#cc7832">as</span> <span style="color:#cc7832">usize</span>).wrapping_add(tx);
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> grid_y = (tetromino.position.row <span style="color:#cc7832">as</span> <span style="color:#cc7832">usize</span>).wrapping_add(ty);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                self.play_grid[grid_y][grid_x] = cell.clone();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    self.clear_filled_rows(stdout)?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">move_to_next</span>(&amp;<span style="color:#cc7832">mut</span> self, stdout: <span style="color:#cc7832">&amp;</span>mut io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    self.current_tetromino = self.next_tetromino.clone();
</span></span><span style="display:flex;"><span>    self.current_tetromino.position.row = <span style="color:#6897bb">0</span>;
</span></span><span style="display:flex;"><span>    self.current_tetromino.position.col =
</span></span><span style="display:flex;"><span>        (<span style="color:#9876aa">PLAY_WIDTH</span> - tetromino_width(&amp;self.current_tetromino.states[<span style="color:#6897bb">0</span>])) <span style="color:#cc7832">as</span> <span style="color:#cc7832">isize</span> / <span style="color:#6897bb">2</span>;
</span></span><span style="display:flex;"><span>    self.render_current_tetromino(stdout)?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    self.next_tetromino = Tetromino::new(<span style="color:#cc7832">true</span>);
</span></span><span style="display:flex;"><span>    self.render_next_tetromino(stdout)?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<p>The next tetromino can be rendered the same as the current one; we just need different coordinates.</p>

<h4 id="handling-key-events">5. Handling key events</h4>

<p>Similar to the automatic drop, we need to handle the key events to move left, right, rotate and hard drop:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">if</span> poll(Duration::from_millis(<span style="color:#6897bb">10</span>))? {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> event = read()?;
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">match</span> event {
</span></span><span style="display:flex;"><span>        Event::Key(KeyEvent {
</span></span><span style="display:flex;"><span>            code,
</span></span><span style="display:flex;"><span>            state: _,
</span></span><span style="display:flex;"><span>            kind,
</span></span><span style="display:flex;"><span>            modifiers: _,
</span></span><span style="display:flex;"><span>        }) =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">if</span> kind == KeyEventKind::Press {
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> tetromino = self.current_tetromino.clone();
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">match</span> code {
</span></span><span style="display:flex;"><span>                    KeyCode::Char(<span style="color:#6a8759">&#39;h&#39;</span>) | KeyCode::Left =&gt; {
</span></span><span style="display:flex;"><span>                        tetromino.move_left(self, stdout)?;
</span></span><span style="display:flex;"><span>                        self.current_tetromino = tetromino;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    KeyCode::Char(<span style="color:#6a8759">&#39;l&#39;</span>) | KeyCode::Right =&gt; {
</span></span><span style="display:flex;"><span>                        tetromino.move_right(self, stdout)?;
</span></span><span style="display:flex;"><span>                        self.current_tetromino = tetromino;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    KeyCode::Char(<span style="color:#6a8759">&#39; &#39;</span>) =&gt; {
</span></span><span style="display:flex;"><span>                        tetromino.rotate(self, stdout)?;
</span></span><span style="display:flex;"><span>                        self.current_tetromino = tetromino;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    KeyCode::Char(<span style="color:#6a8759">&#39;j&#39;</span>) | KeyCode::Down =&gt; {
</span></span><span style="display:flex;"><span>                        tetromino.hard_drop(self, stdout)?;
</span></span><span style="display:flex;"><span>                        self.lock_and_move_to_next(&amp;tetromino, stdout)?;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    _ =&gt; {}
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        _ =&gt; {}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    self.render_current_tetromino(stdout)?;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<p>Moving left, right is straightforward, but what about the rotate? When considering the algorithm for rotating a tetromino, I discovered that we can simplify it by storing all states of a tetromino:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">let</span> t_tetromino_states: Vec&lt;Vec&lt;Vec&lt;Cell&gt;&gt;&gt; = <span style="color:#ffc66d">vec!</span>[
</span></span><span style="display:flex;"><span>    <span style="color:#ffc66d">vec!</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">T_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#ffc66d">vec!</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">T_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#ffc66d">vec!</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">T_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#ffc66d">vec!</span>[
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>, <span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">EMPTY_CELL</span>],
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>];
</span></span></code></pre>
<p>and switch to the next state when rotating:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">rotate</span>(&amp;<span style="color:#cc7832">mut</span> self, game: <span style="color:#cc7832">&amp;</span>mut Game, stdout: <span style="color:#cc7832">&amp;</span>mut std::io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> next_state = (self.current_state + <span style="color:#6897bb">1</span>) % (self.states.len());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> temp_tetromino = self.clone();
</span></span><span style="display:flex;"><span>    temp_tetromino.current_state = next_state;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">if</span> game.can_move(
</span></span><span style="display:flex;"><span>        &amp;temp_tetromino,
</span></span><span style="display:flex;"><span>        self.position.row <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>,
</span></span><span style="display:flex;"><span>        self.position.col <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>,
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>        game.clear_tetromino(stdout)?;
</span></span><span style="display:flex;"><span>        self.current_state = next_state;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<p>The <code>hard_drop</code> function can be implemented by moving down infinitely until it reaches the bottom:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">hard_drop</span>(&amp;<span style="color:#cc7832">mut</span> self, game: <span style="color:#cc7832">&amp;</span>mut Game, stdout: <span style="color:#cc7832">&amp;</span>mut std::io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">while</span> game.can_move(self, self.position.row <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span> + <span style="color:#6897bb">1</span>, self.position.col <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>) {
</span></span><span style="display:flex;"><span>        game.clear_tetromino(stdout)?;
</span></span><span style="display:flex;"><span>        self.position.row += <span style="color:#6897bb">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<h4 id="clearing-filled-lines">6. Clearing the filled lines</h4>

<p>After a tetromino reaches the bottom, we need to check if there are any filled lines. If so, we need to clear them from the playfield and update the score/lines:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">clear_filled_rows</span>(&amp;<span style="color:#cc7832">mut</span> self, stdout: <span style="color:#cc7832">&amp;</span>mut io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> filled_rows: Vec&lt;<span style="color:#cc7832">usize</span>&gt; = Vec::new();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">for</span> row_index <span style="color:#cc7832">in</span> (<span style="color:#6897bb">0</span>..<span style="color:#9876aa">PLAY_HEIGHT</span>).rev() {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">if</span> self.play_grid[row_index][<span style="color:#6897bb">0</span>..<span style="color:#9876aa">PLAY_WIDTH</span>]
</span></span><span style="display:flex;"><span>            .iter()
</span></span><span style="display:flex;"><span>            .all(|cell| cell.symbols == <span style="color:#9876aa">SQUARE_BRACKETS</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            filled_rows.push(row_index);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> new_row = <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">EMPTY_CELL</span>; <span style="color:#9876aa">PLAY_WIDTH</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">for</span> &amp;row_index <span style="color:#cc7832">in</span> filled_rows.iter().rev() {
</span></span><span style="display:flex;"><span>        self.play_grid.remove(row_index);
</span></span><span style="display:flex;"><span>        self.play_grid.insert(<span style="color:#6897bb">0</span>, new_row.clone());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self.lines += <span style="color:#6897bb">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> num_filled_rows = filled_rows.len();
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">match</span> num_filled_rows {
</span></span><span style="display:flex;"><span>        <span style="color:#6897bb">1</span> =&gt; {
</span></span><span style="display:flex;"><span>            self.score += <span style="color:#6897bb">100</span> * (self.level + <span style="color:#6897bb">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#6897bb">2</span> =&gt; {
</span></span><span style="display:flex;"><span>            self.score += <span style="color:#6897bb">300</span> * (self.level + <span style="color:#6897bb">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#6897bb">3</span> =&gt; {
</span></span><span style="display:flex;"><span>            self.score += <span style="color:#6897bb">500</span> * (self.level + <span style="color:#6897bb">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#6897bb">4</span> =&gt; {
</span></span><span style="display:flex;"><span>            self.score += <span style="color:#6897bb">800</span> * (self.level + <span style="color:#6897bb">1</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        _ =&gt; (),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    self.render_changed_portions(stdout)?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<p>To minimize flickering, we only need to re-render the portions that have been changed:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">render_changed_portions</span>(&amp;self, stdout: <span style="color:#cc7832">&amp;</span>mut std::io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    self.render_play_grid(stdout)?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> stats_start_x = self.start_x - <span style="color:#9876aa">STATS_WIDTH</span> - <span style="color:#9876aa">DISTANCE</span> - <span style="color:#6897bb">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#ffc66d">execute!</span>(
</span></span><span style="display:flex;"><span>        stdout,
</span></span><span style="display:flex;"><span>        SetForegroundColor(Color::White),
</span></span><span style="display:flex;"><span>        SetBackgroundColor(Color::Black),
</span></span><span style="display:flex;"><span>        SavePosition,
</span></span><span style="display:flex;"><span>        MoveTo(
</span></span><span style="display:flex;"><span>            stats_start_x <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">2</span> + <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">Score: </span><span style="color:#6a8759">&#34;</span>.len() <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>,
</span></span><span style="display:flex;"><span>            self.start_y <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">2</span>
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        Print(self.score),
</span></span><span style="display:flex;"><span>        MoveTo(
</span></span><span style="display:flex;"><span>            stats_start_x <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">2</span> + <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">Lines: </span><span style="color:#6a8759">&#34;</span>.len() <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>,
</span></span><span style="display:flex;"><span>            self.start_y <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">3</span>
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        Print(self.lines),
</span></span><span style="display:flex;"><span>        MoveTo(
</span></span><span style="display:flex;"><span>            stats_start_x <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">2</span> + <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">Level: </span><span style="color:#6a8759">&#34;</span>.len() <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>,
</span></span><span style="display:flex;"><span>            self.start_y <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">4</span>
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        Print(self.level),
</span></span><span style="display:flex;"><span>        ResetColor,
</span></span><span style="display:flex;"><span>        RestorePosition,
</span></span><span style="display:flex;"><span>    )?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<h4 id="game-over">7. Game over</h4>

<p>Whenever a new tetromino is spawned, if it cannot be placed in the playfield, it means it&rsquo;s game over:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">lock_and_move_to_next</span>(
</span></span><span style="display:flex;"><span>    &amp;<span style="color:#cc7832">mut</span> self,
</span></span><span style="display:flex;"><span>    tetromino: <span style="color:#cc7832">&amp;</span>Tetromino,
</span></span><span style="display:flex;"><span>    stdout: <span style="color:#cc7832">&amp;</span>mut io::Stdout,
</span></span><span style="display:flex;"><span>) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    self.lock_tetromino(tetromino, stdout)?;
</span></span><span style="display:flex;"><span>    self.move_to_next(stdout)?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">if</span> self.is_game_over() {
</span></span><span style="display:flex;"><span>        self.handle_game_over(stdout)?;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">is_game_over</span>(&amp;<span style="color:#cc7832">mut</span> self) -&gt; <span style="color:#cc7832">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> tetromino = self.current_tetromino.clone();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> next_state = (tetromino.current_state + <span style="color:#6897bb">1</span>) % (tetromino.states.len());
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> temp_tetromino = tetromino.clone();
</span></span><span style="display:flex;"><span>    temp_tetromino.current_state = next_state;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">if</span> !self.can_move(
</span></span><span style="display:flex;"><span>        &amp;tetromino,
</span></span><span style="display:flex;"><span>        tetromino.position.row <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>,
</span></span><span style="display:flex;"><span>        tetromino.position.col <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span> - <span style="color:#6897bb">1</span>,
</span></span><span style="display:flex;"><span>    ) &amp;&amp; !self.can_move(
</span></span><span style="display:flex;"><span>        &amp;tetromino,
</span></span><span style="display:flex;"><span>        tetromino.position.row <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>,
</span></span><span style="display:flex;"><span>        tetromino.position.col <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span> + <span style="color:#6897bb">1</span>,
</span></span><span style="display:flex;"><span>    ) &amp;&amp; !self.can_move(
</span></span><span style="display:flex;"><span>        &amp;tetromino,
</span></span><span style="display:flex;"><span>        tetromino.position.row <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span> + <span style="color:#6897bb">1</span>,
</span></span><span style="display:flex;"><span>        tetromino.position.col <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>,
</span></span><span style="display:flex;"><span>    ) &amp;&amp; !self.can_move(
</span></span><span style="display:flex;"><span>        &amp;temp_tetromino,
</span></span><span style="display:flex;"><span>        tetromino.position.row <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>,
</span></span><span style="display:flex;"><span>        tetromino.position.col <span style="color:#cc7832">as</span> <span style="color:#cc7832">i16</span>,
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">return</span> <span style="color:#cc7832">true</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<p>We can check if the player has achieved a new high score and allow them to enter their name:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">handle_game_over</span>(&amp;<span style="color:#cc7832">mut</span> self, stdout: <span style="color:#cc7832">&amp;</span>mut io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">if</span> self.score == <span style="color:#6897bb">0</span> {
</span></span><span style="display:flex;"><span>        self.show_high_scores(stdout)?;
</span></span><span style="display:flex;"><span>    } <span style="color:#cc7832">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">let</span> count: <span style="color:#cc7832">i64</span> =
</span></span><span style="display:flex;"><span>            self.conn
</span></span><span style="display:flex;"><span>                .query_row(<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">SELECT COUNT(*) FROM high_scores</span><span style="color:#6a8759">&#34;</span>, <span style="color:#ffc66d">params!</span>[], |row| {
</span></span><span style="display:flex;"><span>                    row.get(<span style="color:#6897bb">0</span>)
</span></span><span style="display:flex;"><span>                })?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">if</span> count &lt; <span style="color:#6897bb">5</span> {
</span></span><span style="display:flex;"><span>            self.new_high_score(stdout)?;
</span></span><span style="display:flex;"><span>        } <span style="color:#cc7832">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">let</span> player: Player = self.conn.query_row(
</span></span><span style="display:flex;"><span>                <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">SELECT player_name, score FROM high_scores ORDER BY score DESC LIMIT 4,1</span><span style="color:#6a8759">&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#ffc66d">params!</span>[],
</span></span><span style="display:flex;"><span>                |row| Ok(Player { score: row.get(<span style="color:#6897bb">1</span>)? }),
</span></span><span style="display:flex;"><span>            )?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">if</span> (self.score <span style="color:#cc7832">as</span> <span style="color:#cc7832">u64</span>) &lt;= player.score {
</span></span><span style="display:flex;"><span>                self.show_high_scores(stdout)?;
</span></span><span style="display:flex;"><span>            } <span style="color:#cc7832">else</span> {
</span></span><span style="display:flex;"><span>                self.new_high_score(stdout)?;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">new_high_score</span>(&amp;<span style="color:#cc7832">mut</span> self, stdout: <span style="color:#cc7832">&amp;</span>mut std::io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    print_centered_messages(
</span></span><span style="display:flex;"><span>        stdout,
</span></span><span style="display:flex;"><span>        None,
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">vec!</span>[
</span></span><span style="display:flex;"><span>            <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">NEW HIGH SCORE!</span><span style="color:#6a8759">&#34;</span>,
</span></span><span style="display:flex;"><span>            &amp;self.score.to_string(),
</span></span><span style="display:flex;"><span>            <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">&#34;</span>,
</span></span><span style="display:flex;"><span>            &amp;<span style="color:#ffc66d">format!</span>(<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">{}</span><span style="color:#6a8759">{}</span><span style="color:#6a8759">&#34;</span>, <span style="color:#9876aa">ENTER_YOUR_NAME_MESSAGE</span>, <span style="color:#6a8759">&#34;</span><span style="color:#6a8759"> </span><span style="color:#6a8759">&#34;</span>.repeat(<span style="color:#9876aa">MAX_NAME_LENGTH</span>)),
</span></span><span style="display:flex;"><span>        ],
</span></span><span style="display:flex;"><span>    )?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> name = String::new();
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> cursor_position: <span style="color:#cc7832">usize</span> = <span style="color:#6897bb">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> (term_width, term_height) = terminal::size()?;
</span></span><span style="display:flex;"><span>    stdout.execute(MoveTo(
</span></span><span style="display:flex;"><span>        (term_width - <span style="color:#9876aa">ENTER_YOUR_NAME_MESSAGE</span>.len() <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> - <span style="color:#9876aa">MAX_NAME_LENGTH</span> <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>) / <span style="color:#6897bb">2</span>
</span></span><span style="display:flex;"><span>            + <span style="color:#9876aa">ENTER_YOUR_NAME_MESSAGE</span>.len() <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>,
</span></span><span style="display:flex;"><span>        term_height / <span style="color:#6897bb">2</span> - <span style="color:#6897bb">3</span> / <span style="color:#6897bb">2</span> + <span style="color:#6897bb">2</span>,
</span></span><span style="display:flex;"><span>    ))?;
</span></span><span style="display:flex;"><span>    stdout.write(<span style="color:#ffc66d">format!</span>(<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">{}</span><span style="color:#6a8759">&#34;</span>, name).as_bytes())?;
</span></span><span style="display:flex;"><span>    stdout.execute(cursor::Show)?;
</span></span><span style="display:flex;"><span>    stdout.flush()?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">loop</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">if</span> poll(Duration::from_millis(<span style="color:#6897bb">10</span>))? {
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">let</span> event = read()?;
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">match</span> event {
</span></span><span style="display:flex;"><span>                Event::Key(KeyEvent {
</span></span><span style="display:flex;"><span>                    code,
</span></span><span style="display:flex;"><span>                    state: _,
</span></span><span style="display:flex;"><span>                    kind,
</span></span><span style="display:flex;"><span>                    modifiers: _,
</span></span><span style="display:flex;"><span>                }) =&gt; {
</span></span><span style="display:flex;"><span>                    <span style="color:#cc7832">if</span> kind == KeyEventKind::Press {
</span></span><span style="display:flex;"><span>                        <span style="color:#cc7832">match</span> code {
</span></span><span style="display:flex;"><span>                            KeyCode::Backspace =&gt; {
</span></span><span style="display:flex;"><span>                                <span style="color:#808080">// Handle Backspace key to remove characters.
</span></span></span><span style="display:flex;"><span>                                <span style="color:#cc7832">if</span> !name.is_empty() &amp;&amp; cursor_position &gt; <span style="color:#6897bb">0</span> {
</span></span><span style="display:flex;"><span>                                    name.remove(cursor_position - <span style="color:#6897bb">1</span>);
</span></span><span style="display:flex;"><span>                                    cursor_position -= <span style="color:#6897bb">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                    stdout.execute(MoveLeft(<span style="color:#6897bb">1</span>))?;
</span></span><span style="display:flex;"><span>                                    stdout.write(<span style="color:#6a8759">b</span><span style="color:#6a8759">&#34;</span><span style="color:#6a8759"> </span><span style="color:#6a8759">&#34;</span>)?;
</span></span><span style="display:flex;"><span>                                    stdout.flush()?;
</span></span><span style="display:flex;"><span>                                    <span style="color:#ffc66d">print!</span>(<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">{}</span><span style="color:#6a8759">&#34;</span>, &amp;name[cursor_position..]);
</span></span><span style="display:flex;"><span>                                    stdout.execute(MoveLeft(
</span></span><span style="display:flex;"><span>                                        name.len() <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> - cursor_position <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">1</span>,
</span></span><span style="display:flex;"><span>                                    ))?;
</span></span><span style="display:flex;"><span>                                    stdout.flush()?;
</span></span><span style="display:flex;"><span>                                }
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                            KeyCode::Enter =&gt; {
</span></span><span style="display:flex;"><span>                                self.conn.execute(
</span></span><span style="display:flex;"><span>                                    <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">INSERT INTO high_scores (player_name, score) VALUES (?1, ?2)</span><span style="color:#6a8759">&#34;</span>,
</span></span><span style="display:flex;"><span>                                    <span style="color:#ffc66d">params!</span>[name, self.score],
</span></span><span style="display:flex;"><span>                                )?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                                <span style="color:#ffc66d">execute!</span>(stdout.lock(), cursor::Hide)?;
</span></span><span style="display:flex;"><span>                                self.show_high_scores(stdout)?;
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                            KeyCode::Left =&gt; {
</span></span><span style="display:flex;"><span>                                <span style="color:#808080">// Move the cursor left.
</span></span></span><span style="display:flex;"><span>                                <span style="color:#cc7832">if</span> cursor_position &gt; <span style="color:#6897bb">0</span> {
</span></span><span style="display:flex;"><span>                                    stdout.execute(MoveLeft(<span style="color:#6897bb">1</span>))?;
</span></span><span style="display:flex;"><span>                                    cursor_position -= <span style="color:#6897bb">1</span>;
</span></span><span style="display:flex;"><span>                                }
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                            KeyCode::Right =&gt; {
</span></span><span style="display:flex;"><span>                                <span style="color:#808080">// Move the cursor right.
</span></span></span><span style="display:flex;"><span>                                <span style="color:#cc7832">if</span> cursor_position &lt; name.len() {
</span></span><span style="display:flex;"><span>                                    stdout.execute(MoveRight(<span style="color:#6897bb">1</span>))?;
</span></span><span style="display:flex;"><span>                                    cursor_position += <span style="color:#6897bb">1</span>;
</span></span><span style="display:flex;"><span>                                }
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                            KeyCode::Char(c) =&gt; {
</span></span><span style="display:flex;"><span>                                <span style="color:#cc7832">if</span> name.len() &lt; <span style="color:#9876aa">MAX_NAME_LENGTH</span> {
</span></span><span style="display:flex;"><span>                                    name.insert(cursor_position, c);
</span></span><span style="display:flex;"><span>                                    cursor_position += <span style="color:#6897bb">1</span>;
</span></span><span style="display:flex;"><span>                                    <span style="color:#ffc66d">print!</span>(<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">{}</span><span style="color:#6a8759">&#34;</span>, &amp;name[cursor_position - <span style="color:#6897bb">1</span>..]);
</span></span><span style="display:flex;"><span>                                    stdout.flush()?;
</span></span><span style="display:flex;"><span>                                    <span style="color:#cc7832">for</span> _ <span style="color:#cc7832">in</span> cursor_position..name.len() {
</span></span><span style="display:flex;"><span>                                        stdout.execute(MoveLeft(<span style="color:#6897bb">1</span>))?;
</span></span><span style="display:flex;"><span>                                    }
</span></span><span style="display:flex;"><span>                                    stdout.flush()?;
</span></span><span style="display:flex;"><span>                                }
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                            _ =&gt; {}
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                _ =&gt; {}
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<h4 id="pause-and-quit">8. Pause and Quit</h4>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">if</span> poll(Duration::from_millis(<span style="color:#6897bb">10</span>))? {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> event = read()?;
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">match</span> event {
</span></span><span style="display:flex;"><span>        Event::Key(KeyEvent {
</span></span><span style="display:flex;"><span>            code,
</span></span><span style="display:flex;"><span>            state: _,
</span></span><span style="display:flex;"><span>            kind,
</span></span><span style="display:flex;"><span>            modifiers: _,
</span></span><span style="display:flex;"><span>        }) =&gt; {
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">if</span> kind == KeyEventKind::Press {
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> tetromino = self.current_tetromino.clone();
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">match</span> code {
</span></span><span style="display:flex;"><span>                    KeyCode::Char(<span style="color:#6a8759">&#39;p&#39;</span>) =&gt; {
</span></span><span style="display:flex;"><span>                        self.paused = !self.paused;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    KeyCode::Char(<span style="color:#6a8759">&#39;q&#39;</span>) =&gt; {
</span></span><span style="display:flex;"><span>                        self.handle_quit_event(stdout)?;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    _ =&gt; {}
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        _ =&gt; {}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    self.render_current_tetromino(stdout)?;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">handle_pause_event</span>(&amp;<span style="color:#cc7832">mut</span> self, stdout: <span style="color:#cc7832">&amp;</span>mut io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    print_centered_messages(stdout, None, <span style="color:#ffc66d">vec!</span>[<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">PAUSED</span><span style="color:#6a8759">&#34;</span>, <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">&#34;</span>, <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">(C)ontinue | (Q)uit</span><span style="color:#6a8759">&#34;</span>])?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">loop</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">if</span> poll(Duration::from_millis(<span style="color:#6897bb">10</span>))? {
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">let</span> event = read()?;
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">match</span> event {
</span></span><span style="display:flex;"><span>                Event::Key(KeyEvent {
</span></span><span style="display:flex;"><span>                    code,
</span></span><span style="display:flex;"><span>                    modifiers: _,
</span></span><span style="display:flex;"><span>                    kind,
</span></span><span style="display:flex;"><span>                    state: _,
</span></span><span style="display:flex;"><span>                }) =&gt; {
</span></span><span style="display:flex;"><span>                    <span style="color:#cc7832">if</span> kind == KeyEventKind::Press {
</span></span><span style="display:flex;"><span>                        <span style="color:#cc7832">match</span> code {
</span></span><span style="display:flex;"><span>                            KeyCode::Enter | KeyCode::Char(<span style="color:#6a8759">&#39;c&#39;</span>) =&gt; {
</span></span><span style="display:flex;"><span>                                self.render_changed_portions(stdout)?;
</span></span><span style="display:flex;"><span>                                self.paused = <span style="color:#cc7832">false</span>;
</span></span><span style="display:flex;"><span>                                <span style="color:#cc7832">break</span>;
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                            KeyCode::Char(<span style="color:#6a8759">&#39;q&#39;</span>) =&gt; {
</span></span><span style="display:flex;"><span>                                quit(stdout)?;
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                            _ =&gt; {}
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                _ =&gt; {}
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">handle_quit_event</span>(&amp;<span style="color:#cc7832">mut</span> self, stdout: <span style="color:#cc7832">&amp;</span>mut io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    print_centered_messages(stdout, None, <span style="color:#ffc66d">vec!</span>[<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">QUIT?</span><span style="color:#6a8759">&#34;</span>, <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">&#34;</span>, <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">(Y)es | (N)o</span><span style="color:#6a8759">&#34;</span>])?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">loop</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">if</span> poll(Duration::from_millis(<span style="color:#6897bb">10</span>))? {
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">let</span> event = read()?;
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">match</span> event {
</span></span><span style="display:flex;"><span>                Event::Key(KeyEvent {
</span></span><span style="display:flex;"><span>                    code,
</span></span><span style="display:flex;"><span>                    modifiers: _,
</span></span><span style="display:flex;"><span>                    kind,
</span></span><span style="display:flex;"><span>                    state: _,
</span></span><span style="display:flex;"><span>                }) =&gt; {
</span></span><span style="display:flex;"><span>                    <span style="color:#cc7832">if</span> kind == KeyEventKind::Press {
</span></span><span style="display:flex;"><span>                        <span style="color:#cc7832">match</span> code {
</span></span><span style="display:flex;"><span>                            KeyCode::Enter | KeyCode::Char(<span style="color:#6a8759">&#39;y&#39;</span>) =&gt; {
</span></span><span style="display:flex;"><span>                                quit(stdout)?;
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                            KeyCode::Esc | KeyCode::Char(<span style="color:#6a8759">&#39;n&#39;</span>) =&gt; {
</span></span><span style="display:flex;"><span>                                self.render_changed_portions(stdout)?;
</span></span><span style="display:flex;"><span>                                self.paused = <span style="color:#cc7832">false</span>;
</span></span><span style="display:flex;"><span>                                <span style="color:#cc7832">break</span>;
</span></span><span style="display:flex;"><span>                            }
</span></span><span style="display:flex;"><span>                            _ =&gt; {}
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                _ =&gt; {}
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<h4 id="reset">9. Reset</h4>

<p>After the game is over, we can display the highscores table, and allow the player press <code>r</code> to restart:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">reset_game</span>(game: <span style="color:#cc7832">&amp;</span>mut Game, stdout: <span style="color:#cc7832">&amp;</span>mut io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    game.reset();
</span></span><span style="display:flex;"><span>    game.render(stdout)?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    game.handle_event(stdout)?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">reset</span>(&amp;<span style="color:#cc7832">mut</span> self) {
</span></span><span style="display:flex;"><span>    <span style="color:#808080">// Reset play grid
</span></span></span><span style="display:flex;"><span>    self.play_grid = create_grid(
</span></span><span style="display:flex;"><span>        <span style="color:#9876aa">PLAY_WIDTH</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#9876aa">PLAY_HEIGHT</span>,
</span></span><span style="display:flex;"><span>        self.start_with_number_of_filled_lines,
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#808080">// Reset tetrominos
</span></span></span><span style="display:flex;"><span>    self.current_tetromino = Tetromino::new(<span style="color:#cc7832">false</span>);
</span></span><span style="display:flex;"><span>    self.next_tetromino = Tetromino::new(<span style="color:#cc7832">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#808080">// Reset game statistics
</span></span></span><span style="display:flex;"><span>    self.lines = <span style="color:#6897bb">0</span>;
</span></span><span style="display:flex;"><span>    self.level = self.start_at_level;
</span></span><span style="display:flex;"><span>    self.score = <span style="color:#6897bb">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> drop_interval: <span style="color:#cc7832">u64</span> = <span style="color:#9876aa">DEFAULT_INTERVAL</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">for</span> _i <span style="color:#cc7832">in</span> <span style="color:#6897bb">1</span>..=self.start_at_level {
</span></span><span style="display:flex;"><span>        drop_interval -= drop_interval / <span style="color:#6897bb">10</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    self.drop_interval = drop_interval;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#808080">// Clear any existing messages in the receiver
</span></span></span><span style="display:flex;"><span>    <span style="color:#cc7832">if</span> <span style="color:#cc7832">let</span> Some(<span style="color:#cc7832">ref</span> <span style="color:#cc7832">mut</span> receiver) = self.receiver {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">while</span> <span style="color:#cc7832">let</span> Ok(_) = receiver.try_recv() {}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#808080">// Resume the game
</span></span></span><span style="display:flex;"><span>    self.paused = <span style="color:#cc7832">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<h4 id="multiplayer-mode">10. Multiplayer mode</h4>

<p>To make the game more interesting, I want to add the 2-player mode (so I can play with my son). Whenever a player clears some lines, the number of cleared lines will be sent to the competitor.</p>

<p>To do that, first, we need to open a TCP connection between 2 players and then spawn a new thread to receive messages from the competitor:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span>player 1 &lt;--- TCP stream ---&gt; [receive_message thread &lt;--- mpsc::channel --&gt; main thread] player 2
</span></span></code></pre><pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">if</span> args.multiplayer {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">if</span> args.server_address == None {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">let</span> listener = TcpListener::bind(<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">0.0.0.0:8080</span><span style="color:#6a8759">&#34;</span>)?;
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">let</span> my_local_ip = local_ip()?;
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">println!</span>(
</span></span><span style="display:flex;"><span>            <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">Server started. Please invite your competitor to connect to </span><span style="color:#6a8759">{}</span><span style="color:#6a8759">.</span><span style="color:#6a8759">&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#ffc66d">format!</span>(<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">{}</span><span style="color:#6a8759">:8080</span><span style="color:#6a8759">&#34;</span>, my_local_ip)
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">let</span> (stream, _) = listener.accept()?;
</span></span><span style="display:flex;"><span>        <span style="color:#ffc66d">println!</span>(<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">Player 2 connected.</span><span style="color:#6a8759">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> stream_clone = stream.try_clone()?;
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">let</span> (sender, receiver): (Sender&lt;MessageType&gt;, Receiver&lt;MessageType&gt;) = channel();
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> game = Game::new(
</span></span><span style="display:flex;"><span>            conn,
</span></span><span style="display:flex;"><span>            Some(stream),
</span></span><span style="display:flex;"><span>            Some(receiver),
</span></span><span style="display:flex;"><span>            args.number_of_lines_already_filled,
</span></span><span style="display:flex;"><span>            args.level,
</span></span><span style="display:flex;"><span>        )?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        thread::spawn(<span style="color:#cc7832">move</span> || {
</span></span><span style="display:flex;"><span>            receive_message(&amp;<span style="color:#cc7832">mut</span> stream_clone, sender);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        game.start()?;
</span></span><span style="display:flex;"><span>    } <span style="color:#cc7832">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">if</span> <span style="color:#cc7832">let</span> Some(server_address) = args.server_address {
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">let</span> stream = TcpStream::connect(server_address)?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> stream_clone = stream.try_clone()?;
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">let</span> (sender, receiver): (Sender&lt;MessageType&gt;, Receiver&lt;MessageType&gt;) = channel();
</span></span><span style="display:flex;"><span>            <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> game = Game::new(
</span></span><span style="display:flex;"><span>                conn,
</span></span><span style="display:flex;"><span>                Some(stream),
</span></span><span style="display:flex;"><span>                Some(receiver),
</span></span><span style="display:flex;"><span>                number_of_lines_already_filled,
</span></span><span style="display:flex;"><span>                start_at_level,
</span></span><span style="display:flex;"><span>            )?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            thread::spawn(<span style="color:#cc7832">move</span> || {
</span></span><span style="display:flex;"><span>                receive_message(&amp;<span style="color:#cc7832">mut</span> stream_clone, sender);
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            game.start()?;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<p>When a player receives a message, the sender will forward it to the receiver via the channel:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">receive_message</span>(stream: <span style="color:#cc7832">&amp;</span>mut TcpStream, sender: Sender&lt;MessageType&gt;) {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> buffer = [<span style="color:#6897bb">0</span><span style="color:#cc7832">u8</span>; <span style="color:#6897bb">256</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">loop</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">match</span> stream.read(&amp;<span style="color:#cc7832">mut</span> buffer) {
</span></span><span style="display:flex;"><span>            Ok(n) <span style="color:#cc7832">if</span> n &gt; <span style="color:#6897bb">0</span> =&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> msg = String::from_utf8_lossy(&amp;buffer[<span style="color:#6897bb">0</span>..n]);
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">if</span> msg.starts_with(<span style="color:#9876aa">PREFIX_CLEARED_ROWS</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#cc7832">if</span> <span style="color:#cc7832">let</span> Ok(rows) = msg.trim_start_matches(<span style="color:#9876aa">PREFIX_CLEARED_ROWS</span>).parse() {
</span></span><span style="display:flex;"><span>                        <span style="color:#cc7832">if</span> <span style="color:#cc7832">let</span> Err(err) = sender.send(MessageType::ClearedRows(rows)) {
</span></span><span style="display:flex;"><span>                            <span style="color:#ffc66d">eprintln!</span>(<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">Error sending number of cleared rows: </span><span style="color:#6a8759">{}</span><span style="color:#6a8759">&#34;</span>, err)
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                } <span style="color:#cc7832">else</span> <span style="color:#cc7832">if</span> msg.starts_with(<span style="color:#9876aa">PREFIX_NOTIFICATION</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#cc7832">let</span> msg = msg.trim_start_matches(<span style="color:#9876aa">PREFIX_NOTIFICATION</span>).to_string();
</span></span><span style="display:flex;"><span>                    <span style="color:#cc7832">if</span> <span style="color:#cc7832">let</span> Err(err) = sender.send(MessageType::Notification(msg)) {
</span></span><span style="display:flex;"><span>                        <span style="color:#ffc66d">eprintln!</span>(<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">Error sending notification message: </span><span style="color:#6a8759">{}</span><span style="color:#6a8759">&#34;</span>, err)
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            Ok(_) | Err(_) =&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre>
<p>On the receiver side, when a player receive a number of cleared lines, it will add the received number of lines (each with an empty cell in a random column) to the bottom of playfield:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">if</span> <span style="color:#cc7832">let</span> Some(receiver) = &amp;self.receiver {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">for</span> message <span style="color:#cc7832">in</span> receiver.try_iter() {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">match</span> message {
</span></span><span style="display:flex;"><span>            MessageType::ClearedRows(rows) =&gt; {
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> cells =
</span></span><span style="display:flex;"><span>                    <span style="color:#ffc66d">vec!</span>[<span style="color:#9876aa">I_CELL</span>, <span style="color:#9876aa">O_CELL</span>, <span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">S_CELL</span>, <span style="color:#9876aa">Z_CELL</span>, <span style="color:#9876aa">T_CELL</span>, <span style="color:#9876aa">L_CELL</span>];
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> rng = rand::thread_rng();
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> random_cell_index = rng.gen_range(<span style="color:#6897bb">0</span>..cells.len());
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> random_cell = cells[random_cell_index].clone();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> <span style="color:#cc7832">mut</span> new_row = <span style="color:#ffc66d">vec!</span>[random_cell; <span style="color:#9876aa">PLAY_WIDTH</span>];
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> random_column = rng.gen_range(<span style="color:#6897bb">0</span>..<span style="color:#9876aa">PLAY_WIDTH</span>);
</span></span><span style="display:flex;"><span>                new_row[random_column] = <span style="color:#9876aa">EMPTY_CELL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">for</span> _ <span style="color:#cc7832">in</span> <span style="color:#6897bb">0</span>..rows {
</span></span><span style="display:flex;"><span>                    self.play_grid.remove(<span style="color:#6897bb">0</span>);
</span></span><span style="display:flex;"><span>                    self.play_grid.insert(<span style="color:#9876aa">PLAY_HEIGHT</span> - <span style="color:#6897bb">1</span>, new_row.clone());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                self.render_play_grid(stdout)?;
</span></span><span style="display:flex;"><span>            }
</span></span></code></pre>
<p>We also need another component to store the score when playing in 2-player mode:</p>
<pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">struct</span> MultiplayerScore {
</span></span><span style="display:flex;"><span>    my_score: <span style="color:#cc7832">u8</span>,
</span></span><span style="display:flex;"><span>    competitor_score: <span style="color:#cc7832">u8</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cc7832">fn</span> <span style="color:#ffc66d">handle_game_over</span>(&amp;<span style="color:#cc7832">mut</span> self, stdout: <span style="color:#cc7832">&amp;</span>mut io::Stdout) -&gt; Result&lt;()&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">if</span> <span style="color:#cc7832">let</span> Some(stream) = &amp;<span style="color:#cc7832">mut</span> self.stream {
</span></span><span style="display:flex;"><span>        send_message(stream, MessageType::Notification(<span style="color:#6a8759">&#34;</span><span style="color:#6a8759">YOU WIN!</span><span style="color:#6a8759">&#34;</span>.to_string()));
</span></span><span style="display:flex;"><span>        self.multiplayer_score.competitor_score += <span style="color:#6897bb">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">let</span> stats_start_x = self.start_x - <span style="color:#9876aa">STATS_WIDTH</span> - <span style="color:#9876aa">DISTANCE</span> - <span style="color:#6897bb">1</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">if</span> <span style="color:#cc7832">let</span> Some(_) = &amp;self.stream {
</span></span><span style="display:flex;"><span>            <span style="color:#ffc66d">execute!</span>(
</span></span><span style="display:flex;"><span>                stdout,
</span></span><span style="display:flex;"><span>                SetForegroundColor(Color::White),
</span></span><span style="display:flex;"><span>                SetBackgroundColor(Color::Black),
</span></span><span style="display:flex;"><span>                SavePosition,
</span></span><span style="display:flex;"><span>                MoveTo(
</span></span><span style="display:flex;"><span>                    stats_start_x <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">2</span> + <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">Score: </span><span style="color:#6a8759">&#34;</span>.len() <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>,
</span></span><span style="display:flex;"><span>                    self.start_y <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">10</span>
</span></span><span style="display:flex;"><span>                ),
</span></span><span style="display:flex;"><span>                Print(<span style="color:#ffc66d">format!</span>(
</span></span><span style="display:flex;"><span>                    <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">{}</span><span style="color:#6a8759"> - </span><span style="color:#6a8759">{}</span><span style="color:#6a8759">&#34;</span>,
</span></span><span style="display:flex;"><span>                    self.multiplayer_score.my_score, self.multiplayer_score.competitor_score
</span></span><span style="display:flex;"><span>                )),
</span></span><span style="display:flex;"><span>                ResetColor,
</span></span><span style="display:flex;"><span>                RestorePosition,
</span></span><span style="display:flex;"><span>            )?;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre><pre style="color:#a9b7c6;background-color:#2b2b2b;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code><span style="display:flex;"><span><span style="color:#cc7832">if</span> <span style="color:#cc7832">let</span> Some(receiver) = &amp;self.receiver {
</span></span><span style="display:flex;"><span>    <span style="color:#cc7832">for</span> message <span style="color:#cc7832">in</span> receiver.try_iter() {
</span></span><span style="display:flex;"><span>        <span style="color:#cc7832">match</span> message {
</span></span><span style="display:flex;"><span>            MessageType::Notification(msg) =&gt; {
</span></span><span style="display:flex;"><span>                self.paused = !self.paused;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                print_centered_messages(
</span></span><span style="display:flex;"><span>                    stdout,
</span></span><span style="display:flex;"><span>                    None,
</span></span><span style="display:flex;"><span>                    <span style="color:#ffc66d">vec!</span>[&amp;msg, <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">&#34;</span>, <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">(R)estart | (C)ontinue | (Q)uit</span><span style="color:#6a8759">&#34;</span>],
</span></span><span style="display:flex;"><span>                )?;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                self.multiplayer_score.my_score += <span style="color:#6897bb">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">let</span> stats_start_x = self.start_x - <span style="color:#9876aa">STATS_WIDTH</span> - <span style="color:#9876aa">DISTANCE</span> - <span style="color:#6897bb">1</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#cc7832">if</span> <span style="color:#cc7832">let</span> Some(_) = &amp;self.stream {
</span></span><span style="display:flex;"><span>                    <span style="color:#ffc66d">execute!</span>(
</span></span><span style="display:flex;"><span>                        stdout,
</span></span><span style="display:flex;"><span>                        SetForegroundColor(Color::White),
</span></span><span style="display:flex;"><span>                        SetBackgroundColor(Color::Black),
</span></span><span style="display:flex;"><span>                        SavePosition,
</span></span><span style="display:flex;"><span>                        MoveTo(
</span></span><span style="display:flex;"><span>                            stats_start_x <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">2</span> + <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">Score: </span><span style="color:#6a8759">&#34;</span>.len() <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span>,
</span></span><span style="display:flex;"><span>                            self.start_y <span style="color:#cc7832">as</span> <span style="color:#cc7832">u16</span> + <span style="color:#6897bb">10</span>
</span></span><span style="display:flex;"><span>                        ),
</span></span><span style="display:flex;"><span>                        Print(<span style="color:#ffc66d">format!</span>(
</span></span><span style="display:flex;"><span>                            <span style="color:#6a8759">&#34;</span><span style="color:#6a8759">{}</span><span style="color:#6a8759"> - </span><span style="color:#6a8759">{}</span><span style="color:#6a8759">&#34;</span>,
</span></span><span style="display:flex;"><span>                            self.multiplayer_score.my_score,
</span></span><span style="display:flex;"><span>                            self.multiplayer_score.competitor_score
</span></span><span style="display:flex;"><span>                        )),
</span></span><span style="display:flex;"><span>                        ResetColor,
</span></span><span style="display:flex;"><span>                        RestorePosition,
</span></span><span style="display:flex;"><span>                    )?;
</span></span><span style="display:flex;"><span>                }
</span></span></code></pre>
<p>Throughout <a href="https://github.com/quantonganh/tetris-tui/">this project</a>, I gained invaluable insights, including:</p>

<ul>
<li>Crafting a cross platform CLI application with <a href="https://docs.rs/crossterm/latest/crossterm/">crossterm</a></li>
<li>Establishing communication between two machines through <a href="https://doc.rust-lang.org/stable/std/net/struct.TcpStream.html">TcpStream</a></li>
<li>Effectively passing data between threads utilizing <a href="https://doc.rust-lang.org/stable/std/sync/mpsc/fn.channel.html">mpsc::channel</a></li>
<li>&hellip;</li>
</ul>

<p>PS: I am currently seeking a new remote software engineering opportunity with a focus on backend development. My flexibility extends accommodating time zones within a range of +/- 3 hours from ICT (Indochina Time). If you have any information regarding companies or positions that are actively hiring for such roles, I would greately approciate it if you can kindly leave a comment or get in touch. Your assistance is sincerely valued. Thank you.</p>

</article>


<p>
  Categories:
  
  <a class="btn btn-outline-primary" href="/categories/Programming" role="button">Programming</a>
  
</p>



<p>
  Tags:
  
  <a class="btn btn-outline-secondary" href="/tags/rust" role="button">
    <i class="bi bi-tag"></i>
    rust
  </a>
  
  <a class="btn btn-outline-secondary" href="/tags/tetris" role="button">
    <i class="bi bi-tag"></i>
    tetris
  </a>
  
</p>

<div class="d-flex flex-row-reverse">
  <a class="btn btn-outline-info" href="https://github.com/quantonganh/ssgo/edit/master//posts/2023/10/03/tetris-terminal"
    title="Edit this page on GitHub" target="_blank" rel="noopener">
    <i class="bi bi-pencil"></i>
    Edit on GitHub
  </a>
</div>
<hr />

<table>
  <tr>
    
    <td>
      <div class="d-md-flex">
        <a class="page-link" href="/posts/2025/08/14/jdtls-wrapper">
          <span aria-hidden="true">&laquo;</span>
          Previous
        </a>
      </div>
    </td>
    
    
  </tr>
</table>
<script src="https://utteranc.es/client.js" repo="quantonganh/blog" issue-term="pathname" theme="github-light"
  crossorigin="anonymous" async>
  </script>

    
    
  </article>

  <script>
    (function () {
      'use strict';
      window.addEventListener('load', function () {
        let forms = document.getElementsByClassName('needs-validation');
        Array.prototype.filter.call(forms, function (form) {
          form.addEventListener('submit', function (event) {
            if (form.checkValidity() === false) {
              event.preventDefault();
              event.stopPropagation();
            }
            form.classList.add('was-validated');
          }, false);
        });
      }, false);
    })();
  </script>

  <footer class="text-center mt-auto">
    <div class="navi">
      <ul>
        <li>
          <a href="/archives">Archives</a>
        </li>
        <li>
          <a href="/sitemap.xml">Sitemap</a>
        </li>
        <li>
          <a href="/rss.xml">RSS</a>
        </li>
      </ul>
    </div>
  </footer>
</body>

</html>
