
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Learning Rust by building Tetris: my favorite childhood game</title>
  <meta name="description"
    content="">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
    integrity="sha384-tKLJeE1ALTUwtXlaGjJYM3sejfssWdAaWR2s97axw4xkiAdMzQjtOjgcyw0Y50KU" crossorigin="anonymous">
  <link rel="stylesheet" href="/static/css/index.css">
  <link rel="stylesheet" href="/static/css/basic.css">
  <link rel="stylesheet" href="/static/css/grid.css">

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"
    integrity="sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"
    integrity="sha384-YnGSHPPWEUDKMHFPOVmNP7Xyfwx5G0CHet6IoNgiX6CbFZS8gCeIfEgB1MgPwjdI"
    crossorigin="anonymous"></script>
</head>

<body class="d-flex flex-column min-vh-100">
  <article>
    <header class="text-center">
      <div class="title">
        <a href="/">
          <img class="quanface" src="/static/images/quanface.png" />
          Quan Tong
        </a>
      </div>
      <i>"Life is all about sharing. If we are good at something, pass it on." - Mary Berry</i>
      <div class="navi">
        <ul>
          <li>
            <a href="/about">About</a>
          </li>
          <li>
            <a href="/projects">Projects</a>
          </li>
          <li>
            <a href="/photos">Photos</a>
          </li>
          <li>
            <a class="dropdown-toggle" href="#" role="button" id="categoriesMenuLink" data-toggle="dropdown"
              aria-haspopup="true" aria-expanded="false">
              Categories
            </a>

            <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
              
              <a class="dropdown-item" href="/categories/Cu%e1%bb%99c%20s%e1%bb%91ng">Cuộc sống (12)</a>
              
              <a class="dropdown-item" href="/categories/DevOps">DevOps (19)</a>
              
              <a class="dropdown-item" href="/categories/Development%20Environment">Development Environment (15)</a>
              
              <a class="dropdown-item" href="/categories/Du%20l%e1%bb%8bch">Du lịch (11)</a>
              
              <a class="dropdown-item" href="/categories/Networking">Networking (4)</a>
              
              <a class="dropdown-item" href="/categories/Operating%20System">Operating System (1)</a>
              
              <a class="dropdown-item" href="/categories/Programming">Programming (30)</a>
              
            </div>
          </li>
          <li>
            <a href="/tags">Tags</a>
          </li>
        </ul>
      </div>
    </header>
    <hr>
    
<h3>Learning Rust by building Tetris: my favorite childhood game</h3>
<p class="text-secondary">2023-10-03</p>

<p>
    Categories:
    
    <a class="btn btn-outline-primary" href="/categories/Programming" role="button">Programming</a>
    
</p>

<p><img src="tetris-2-player.gif" alt="Play tetris 2-player mode in the terminal" /></p>

<p>After completing the <a href="https://doc.rust-lang.org/book/">Rust book</a> and working through <a href="https://github.com/rust-lang/rustlings">rustlings</a>, I found myself standing at the crossroads, wondering where to go next. It was then that I had an idea - a project that would allow me to apply my newfound knowledge and create something meaningful. My favorite childhood game, Tetris, became the inspiration for my next coding adventure.</p>

<p>Since I want it to be playable on Windows, I chose the TUI library <a href="https://github.com/crossterm-rs/crossterm">crossterm</a>.</p>

<ol>
<li><a href="#drawing-borders-and-playfield">Drawing borders and the playfield</a></li>
<li><a href="#drawing-tetrominoes">Drawing tetrominoes</a></li>
<li><a href="#automatic-and-soft-drop">Automatic and soft drop</a></li>
<li><a href="#lock-tetromino-and-move-to-next">Lock tetromino and move to the next</a></li>
<li><a href="#handling-key-events">Handling key events</a></li>
<li><a href="#clearing-filled-lines">Clearing the filled lines</a></li>
<li><a href="#game-over">Game over</a></li>
<li><a href="#pause-and-quit">Pause and Quit</a></li>
<li><a href="#reset">Reset</a></li>
<li><a href="#multiplayer-mode">Multiplayer mode</a></li>
</ol>

<h4 id="drawing-borders-and-playfield">1. Drawing borders and playfield</h4>

<p>The initial step is to draw the borders. The standard Tetris playing field has 20 rows and 10 columns. I&rsquo;ve designated the pipe operator (<code>|</code>) for the left and right borders and a dash (<code>-</code>) for the top and bottom borders:</p>

<p>The function takes input in the form of coordinates, width and height parameters representing the playing field:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">render_frame</span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>io::Stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>title: <span style="color:#cf222e">&amp;</span><span style="color:#cf222e">str</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>start_x: <span style="color:#cf222e">usize</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>start_y: <span style="color:#cf222e">usize</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>width: <span style="color:#cf222e">usize</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>height: <span style="color:#cf222e">usize</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">execute!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>SetForegroundColor<span style="color:#1f2328">(</span>Color::White<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>SetBackgroundColor<span style="color:#1f2328">(</span>Color::Black<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#57606a">// Print the top border
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>left<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>width<span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span>title<span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">/</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">execute!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>MoveTo<span style="color:#1f2328">(</span>start_x<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>start_y<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>Print<span style="color:#1f2328">(</span><span style="color:#6639ba">format!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">|</span><span style="color:#0a3069">{}</span><span style="color:#0a3069"> </span><span style="color:#0a3069">{}</span><span style="color:#0a3069"> </span><span style="color:#0a3069">{}</span><span style="color:#0a3069">|</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">-</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">.</span>repeat<span style="color:#1f2328">(</span>left<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">usize</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>title<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">-</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">.</span>repeat<span style="color:#1f2328">(</span>width<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">usize</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span>left<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">usize</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span>title<span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#57606a">// Print the left and right borders
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span>index<span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span>height<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">execute!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>MoveTo<span style="color:#1f2328">(</span>start_x<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>start_y<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>index<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>Print<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">|</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>MoveTo<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>start_x<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>width<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>start_y<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>index<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>Print<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">|</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#57606a">// Print the bottom border
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">execute!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>MoveTo<span style="color:#1f2328">(</span>start_x<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>start_y<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>height<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>Print<span style="color:#1f2328">(</span><span style="color:#6639ba">format!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff"></span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">|</span><span style="color:#0a3069">{}</span><span style="color:#0a3069">|</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">-</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>repeat<span style="color:#1f2328">(</span>width<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">usize</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>stdout<span style="color:#1f2328">.</span>flush<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<p>the borders can be rendered as:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">const</span><span style="color:#fff"> </span><span style="color:#0550ae">PLAY_WIDTH</span>: <span style="color:#cf222e">usize</span> <span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">10</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#cf222e">const</span><span style="color:#fff"> </span><span style="color:#0550ae">PLAY_HEIGHT</span>: <span style="color:#cf222e">usize</span> <span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">20</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#cf222e">const</span><span style="color:#fff"> </span><span style="color:#0550ae">SQUARE_BRACKETS</span>: <span style="color:#cf222e">&amp;</span><span style="color:#cf222e">str</span> <span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">[ ]</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span></code></pre><pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span>render_frame<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">Tetris</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_x<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_y<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">PLAY_WIDTH</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#0550ae">3</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">PLAY_HEIGHT</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span></code></pre>
<p>As I use square brackets to make up the tetromino, we need to multiply <code>PLAY_WIDTH</code> by 3:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">create_grid</span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>width: <span style="color:#cf222e">usize</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>height: <span style="color:#cf222e">usize</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Vec</span><span style="color:#0550ae">&lt;</span><span style="color:#6639ba">Vec</span><span style="color:#0550ae">&lt;</span>Cell<span style="color:#0550ae">&gt;</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>grid<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">;</span><span style="color:#fff"> </span>width<span style="color:#1f2328">]</span><span style="color:#1f2328">;</span><span style="color:#fff"> </span>height<span style="color:#1f2328">]</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>grid<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre><pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>play_grid<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>create_grid<span style="color:#1f2328">(</span><span style="color:#0550ae">PLAY_WIDTH</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">PLAY_HEIGHT</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span></code></pre>
<h4 id="drawing-tetrominoes">2. Drawing Tetrominoes</h4>

<p>A tetromino can be represented as:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">struct</span> <span style="color:#1f2328">Tetromino</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>states: <span style="color:#6639ba">Vec</span><span style="color:#0550ae">&lt;</span><span style="color:#6639ba">Vec</span><span style="color:#0550ae">&lt;</span><span style="color:#6639ba">Vec</span><span style="color:#0550ae">&lt;</span>Cell<span style="color:#0550ae">&gt;</span><span style="color:#0550ae">&gt;</span><span style="color:#0550ae">&gt;</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>current_state: <span style="color:#cf222e">usize</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>position: <span style="color:#1f2328">Position</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre><pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">const</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span>: <span style="color:#1f2328">Cell</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>Cell<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>symbols: <span style="color:#1f2328">SQUARE_BRACKETS</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>color: <span style="color:#1f2328">Color</span>::Cyan<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span></code></pre><pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>i_tetromino_states: <span style="color:#6639ba">Vec</span><span style="color:#0550ae">&lt;</span><span style="color:#6639ba">Vec</span><span style="color:#0550ae">&lt;</span><span style="color:#6639ba">Vec</span><span style="color:#0550ae">&lt;</span>Cell<span style="color:#0550ae">&gt;</span><span style="color:#0550ae">&gt;</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">]</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span></code></pre>
<p>To draw a tetromino, we just need to loop through the its current state, and draw each cell with corresponding color:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">render_current_tetromino</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>std::io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>current_tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>row_index<span style="color:#1f2328">,</span><span style="color:#fff"> </span>row<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span>current_tetromino<span style="color:#1f2328">.</span>states<span style="color:#1f2328">[</span>current_tetromino<span style="color:#1f2328">.</span>current_state<span style="color:#1f2328">]</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">.</span>iter<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">.</span>enumerate<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>col_index<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">ref</span><span style="color:#fff"> </span>cell<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span>row<span style="color:#1f2328">.</span>iter<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>enumerate<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>grid_x<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>current_tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>col<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>col_index<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">isize</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>grid_y<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>current_tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>row_index<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">isize</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>cell<span style="color:#1f2328">.</span>symbols<span style="color:#fff"> </span><span style="color:#0550ae">!</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">SPACE</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>grid_x<span style="color:#fff"> </span><span style="color:#0550ae">&lt;</span><span style="color:#fff"> </span><span style="color:#0550ae">PLAY_WIDTH</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">isize</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#0550ae">&amp;</span><span style="color:#fff"> </span>grid_y<span style="color:#fff"> </span><span style="color:#0550ae">&lt;</span><span style="color:#fff"> </span><span style="color:#0550ae">PLAY_HEIGHT</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">isize</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#6639ba">execute!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>SavePosition<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>MoveTo<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_x<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>grid_x<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#0550ae">CELL_WIDTH</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_y<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>grid_y<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>SetForegroundColor<span style="color:#1f2328">(</span>cell<span style="color:#1f2328">.</span>color<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>SetBackgroundColor<span style="color:#1f2328">(</span>Color::Black<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>Print<span style="color:#1f2328">(</span>cell<span style="color:#1f2328">.</span>symbols<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>ResetColor<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>RestorePosition<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<h4 id="automatic-and-soft-drop">3. Automatic and soft drop</h4>

<h5>3.1 Automatic drop</h5>

<p>First, we need to write a function to detect the collision. To do this, we need to check if the new column / row (after moving) goes outside of the playfield, or if that cell is already occupied:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">can_move</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>tetromino: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">Tetromino</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>new_row: <span style="color:#cf222e">i16</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>new_col: <span style="color:#cf222e">i16</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>t_row<span style="color:#1f2328">,</span><span style="color:#fff"> </span>row<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span>tetromino<span style="color:#1f2328">.</span>get_cells<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>iter<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>enumerate<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>t_col<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">ref</span><span style="color:#fff"> </span>cell<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span>row<span style="color:#1f2328">.</span>iter<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>enumerate<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>cell<span style="color:#1f2328">.</span>symbols<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">SQUARE_BRACKETS</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>grid_x<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>new_col<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>t_col<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>grid_y<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>new_row<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>t_row<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>grid_x<span style="color:#fff"> </span><span style="color:#0550ae">&lt;</span><span style="color:#fff"> </span><span style="color:#0550ae">0</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#0550ae">|</span><span style="color:#0550ae">|</span><span style="color:#fff"> </span>grid_x<span style="color:#fff"> </span><span style="color:#0550ae">&gt;</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">PLAY_WIDTH</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#0550ae">|</span><span style="color:#0550ae">|</span><span style="color:#fff"> </span>grid_y<span style="color:#fff"> </span><span style="color:#0550ae">&gt;</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">PLAY_HEIGHT</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#0550ae">|</span><span style="color:#0550ae">|</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>play_grid<span style="color:#1f2328">[</span>grid_y<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">usize</span><span style="color:#1f2328">]</span><span style="color:#1f2328">[</span>grid_x<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">usize</span><span style="color:#1f2328">]</span><span style="color:#1f2328">.</span>symbols<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#0550ae">=</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">SQUARE_BRACKETS</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#cf222e">return</span><span style="color:#fff"> </span><span style="color:#cf222e">false</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">true</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<p>At a regular interval, we will check if a tetromino can be moved down, and if so, we will increase the row by 1, clear the old tetromino and draw a new one:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>drop_timer<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>Instant::now<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>drop_timer<span style="color:#1f2328">.</span>elapsed<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">&gt;</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>Duration::from_millis<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>drop_interval<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#1f2328">.</span>clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>can_move_down<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>can_move<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">&amp;</span>tetromino<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>col<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>can_move_down<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>tetromino<span style="color:#1f2328">.</span>move_down<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>tetromino<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff"> </span><span style="color:#cf222e">else</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>lock_and_move_to_next<span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span>tetromino<span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>render_current_tetromino<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>drop_timer<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>Instant::now<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre><pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">move_down</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>game: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>Game<span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>std::io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>game<span style="color:#1f2328">.</span>can_move<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>col<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>game<span style="color:#1f2328">.</span>clear_tetromino<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<p>To clear the old tetromino, we just need to draw an empty cell:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">clear_tetromino</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>std::io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>row_index<span style="color:#1f2328">,</span><span style="color:#fff"> </span>row<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span>tetromino<span style="color:#1f2328">.</span>states<span style="color:#1f2328">[</span>tetromino<span style="color:#1f2328">.</span>current_state<span style="color:#1f2328">]</span><span style="color:#1f2328">.</span>iter<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>enumerate<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>col_index<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">ref</span><span style="color:#fff"> </span>cell<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span>row<span style="color:#1f2328">.</span>iter<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>enumerate<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>grid_x<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>col<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>col_index<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">isize</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>grid_y<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>row_index<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">isize</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>cell<span style="color:#1f2328">.</span>symbols<span style="color:#fff"> </span><span style="color:#0550ae">!</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">SPACE</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#6639ba">execute!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>SetBackgroundColor<span style="color:#1f2328">(</span>Color::Black<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>SavePosition<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>MoveTo<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_x<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>grid_x<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#0550ae">CELL_WIDTH</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_y<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span>grid_y<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>Print<span style="color:#1f2328">(</span><span style="color:#0550ae">SPACE</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>ResetColor<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>RestorePosition<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<h5 id="soft-drop">3.2. Soft drop</h5>

<p>At the starting levels, we may need a way to make the tetromino drop faster than the regular interval. That&rsquo;s when the soft drop comes into play.</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>kind<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>KeyEventKind::Press<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#1f2328">.</span>clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>code<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>KeyCode::Char<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;s&#39;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">|</span><span style="color:#fff"> </span>KeyCode::Up<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>soft_drop_timer<span style="color:#1f2328">.</span>elapsed<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#0550ae">&gt;</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>Duration::from_millis<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>drop_interval<span style="color:#fff"> </span><span style="color:#0550ae">/</span><span style="color:#fff"> </span><span style="color:#0550ae">8</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#1f2328">.</span>clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>can_move<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#0550ae">&amp;</span>tetromino<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>col<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>tetromino<span style="color:#1f2328">.</span>move_down<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>tetromino<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#fff"> </span><span style="color:#cf222e">else</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>lock_and_move_to_next<span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span>tetromino<span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>soft_drop_timer<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>Instant::now<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<h4 id="lock-tetromino-and-move-to-next">4. Lock tetromino and move the next</h4>

<p>When a tetromino reaches the bottom, we need to lock it at that position and move on to the next one:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">lock_and_move_to_next</span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>tetromino: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">Tetromino</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>io::Stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>lock_tetromino<span style="color:#1f2328">(</span>tetromino<span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>move_to_next<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre><pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">lock_tetromino</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>tetromino: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">Tetromino</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>ty<span style="color:#1f2328">,</span><span style="color:#fff"> </span>row<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span>tetromino<span style="color:#1f2328">.</span>get_cells<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>iter<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>enumerate<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>tx<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">ref</span><span style="color:#fff"> </span>cell<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span>row<span style="color:#1f2328">.</span>iter<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>enumerate<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>cell<span style="color:#1f2328">.</span>symbols<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">SQUARE_BRACKETS</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>grid_x<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>col<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">usize</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>wrapping_add<span style="color:#1f2328">(</span>tx<span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>grid_y<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">usize</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>wrapping_add<span style="color:#1f2328">(</span>ty<span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>play_grid<span style="color:#1f2328">[</span>grid_y<span style="color:#1f2328">]</span><span style="color:#1f2328">[</span>grid_x<span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>cell<span style="color:#1f2328">.</span>clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>clear_filled_rows<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">move_to_next</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>next_tetromino<span style="color:#1f2328">.</span>clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>col<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">(</span><span style="color:#0550ae">PLAY_WIDTH</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span>tetromino_width<span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#1f2328">.</span>states<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">isize</span><span style="color:#fff"> </span><span style="color:#0550ae">/</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>render_current_tetromino<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>next_tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>Tetromino::new<span style="color:#1f2328">(</span><span style="color:#cf222e">true</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>render_next_tetromino<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<p>The next tetromino can be rendered the same as the current one; we just need different coordinates.</p>

<h4 id="handling-key-events">5. Handling key events</h4>

<p>Similar to the automatic drop, we need to handle the key events to move left, right, rotate and hard drop:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>poll<span style="color:#1f2328">(</span>Duration::from_millis<span style="color:#1f2328">(</span><span style="color:#0550ae">10</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>event<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>read<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>event<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>Event::Key<span style="color:#1f2328">(</span>KeyEvent<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>code<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>state: <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>kind<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>modifiers: <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>kind<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>KeyEventKind::Press<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#1f2328">.</span>clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>code<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>KeyCode::Char<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;h&#39;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">|</span><span style="color:#fff"> </span>KeyCode::Left<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>tetromino<span style="color:#1f2328">.</span>move_left<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>tetromino<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>KeyCode::Char<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;l&#39;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">|</span><span style="color:#fff"> </span>KeyCode::Right<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>tetromino<span style="color:#1f2328">.</span>move_right<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>tetromino<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>KeyCode::Char<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39; &#39;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>tetromino<span style="color:#1f2328">.</span>rotate<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>tetromino<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>KeyCode::Char<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;j&#39;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">|</span><span style="color:#fff"> </span>KeyCode::Down<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>tetromino<span style="color:#1f2328">.</span>hard_drop<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>lock_and_move_to_next<span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span>tetromino<span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>_<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>_<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>render_current_tetromino<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<p>Moving left, right is straightforward, but what about the rotate? When considering the algorithm for rotating a tetromino, I discovered that we can simplify it by storing all states of a tetromino:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>t_tetromino_states: <span style="color:#6639ba">Vec</span><span style="color:#0550ae">&lt;</span><span style="color:#6639ba">Vec</span><span style="color:#0550ae">&lt;</span><span style="color:#6639ba">Vec</span><span style="color:#0550ae">&lt;</span>Cell<span style="color:#0550ae">&gt;</span><span style="color:#0550ae">&gt;</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">]</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span></code></pre>
<p>and switch to the next state when rotating:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">rotate</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>game: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>Game<span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>std::io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>next_state<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_state<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">%</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>states<span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>temp_tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>temp_tetromino<span style="color:#1f2328">.</span>current_state<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>next_state<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>game<span style="color:#1f2328">.</span>can_move<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">&amp;</span>temp_tetromino<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>col<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>game<span style="color:#1f2328">.</span>clear_tetromino<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_state<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>next_state<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<p>The <code>hard_drop</code> function can be implemented by moving down infinitely until it reaches the bottom:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">hard_drop</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>game: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>Game<span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>std::io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">while</span><span style="color:#fff"> </span>game<span style="color:#1f2328">.</span>can_move<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>col<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>game<span style="color:#1f2328">.</span>clear_tetromino<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<h4 id="clearing-filled-lines">6. Clearing the filled lines</h4>

<p>After a tetromino reaches the bottom, we need to check if there are any filled lines. If so, we need to clear them from the playfield and update the score/lines:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">clear_filled_rows</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>filled_rows: <span style="color:#6639ba">Vec</span><span style="color:#0550ae">&lt;</span><span style="color:#cf222e">usize</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6639ba">Vec</span>::new<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span>row_index<span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#0550ae">..</span><span style="color:#0550ae">PLAY_HEIGHT</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>rev<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>play_grid<span style="color:#1f2328">[</span>row_index<span style="color:#1f2328">]</span><span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#0550ae">..</span><span style="color:#0550ae">PLAY_WIDTH</span><span style="color:#1f2328">]</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">.</span>iter<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">.</span>all<span style="color:#1f2328">(</span><span style="color:#0550ae">|</span>cell<span style="color:#0550ae">|</span><span style="color:#fff"> </span>cell<span style="color:#1f2328">.</span>symbols<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">SQUARE_BRACKETS</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>filled_rows<span style="color:#1f2328">.</span>push<span style="color:#1f2328">(</span>row_index<span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>new_row<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">;</span><span style="color:#fff"> </span><span style="color:#0550ae">PLAY_WIDTH</span><span style="color:#1f2328">]</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span>row_index<span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span>filled_rows<span style="color:#1f2328">.</span>iter<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>rev<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>play_grid<span style="color:#1f2328">.</span>remove<span style="color:#1f2328">(</span>row_index<span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>play_grid<span style="color:#1f2328">.</span>insert<span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>new_row<span style="color:#1f2328">.</span>clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>lines<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>num_filled_rows<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>filled_rows<span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>num_filled_rows<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">1</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>score<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">100</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>level<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">2</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>score<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">300</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>level<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">3</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>score<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">500</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>level<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">4</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>score<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">800</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>level<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>_<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>render_changed_portions<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<p>To minimize flickering, we only need to re-render the portions that have been changed:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">render_changed_portions</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>std::io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>render_play_grid<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>stats_start_x<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_x<span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">STATS_WIDTH</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">DISTANCE</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">execute!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>SetForegroundColor<span style="color:#1f2328">(</span>Color::White<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>SetBackgroundColor<span style="color:#1f2328">(</span>Color::Black<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>SavePosition<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>MoveTo<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>stats_start_x<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">Score: </span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_y<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>Print<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>score<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>MoveTo<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>stats_start_x<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">Lines: </span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_y<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">3</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>Print<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>lines<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>MoveTo<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>stats_start_x<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">Level: </span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_y<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">4</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>Print<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>level<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>ResetColor<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>RestorePosition<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<h4 id="game-over">7. Game over</h4>

<p>Whenever a new tetromino is spawned, if it cannot be placed in the playfield, it means it&rsquo;s game over:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">lock_and_move_to_next</span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>tetromino: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">Tetromino</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>io::Stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>lock_tetromino<span style="color:#1f2328">(</span>tetromino<span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>move_to_next<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>is_game_over<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>handle_game_over<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">is_game_over</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#cf222e">bool</span> <span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#1f2328">.</span>clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>next_state<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>tetromino<span style="color:#1f2328">.</span>current_state<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">%</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>tetromino<span style="color:#1f2328">.</span>states<span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>temp_tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>tetromino<span style="color:#1f2328">.</span>clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>temp_tetromino<span style="color:#1f2328">.</span>current_state<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>next_state<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#0550ae">!</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>can_move<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">&amp;</span>tetromino<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>col<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#0550ae">&amp;</span><span style="color:#fff"> </span><span style="color:#0550ae">!</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>can_move<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">&amp;</span>tetromino<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>col<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#0550ae">&amp;</span><span style="color:#fff"> </span><span style="color:#0550ae">!</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>can_move<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">&amp;</span>tetromino<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>col<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#0550ae">&amp;</span><span style="color:#fff"> </span><span style="color:#0550ae">!</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>can_move<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">&amp;</span>temp_tetromino<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>row<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>tetromino<span style="color:#1f2328">.</span>position<span style="color:#1f2328">.</span>col<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">i16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">return</span><span style="color:#fff"> </span><span style="color:#cf222e">true</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">false</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<p>We can check if the player has achieved a new high score and allow them to enter their name:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">handle_game_over</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>score<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">0</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>show_high_scores<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff"> </span><span style="color:#cf222e">else</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>count: <span style="color:#cf222e">i64</span> <span style="color:#0550ae">=</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>conn<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">.</span>query_row<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">SELECT COUNT(*) FROM high_scores</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#6639ba">params!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">|</span>row<span style="color:#0550ae">|</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>row<span style="color:#1f2328">.</span>get<span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>count<span style="color:#fff"> </span><span style="color:#0550ae">&lt;</span><span style="color:#fff"> </span><span style="color:#0550ae">5</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>new_high_score<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff"> </span><span style="color:#cf222e">else</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>player: <span style="color:#1f2328">Player</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>conn<span style="color:#1f2328">.</span>query_row<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">SELECT player_name, score FROM high_scores ORDER BY score DESC LIMIT 4,1</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#6639ba">params!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#0550ae">|</span>row<span style="color:#0550ae">|</span><span style="color:#fff"> </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span>Player<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff"> </span>score: <span style="color:#1f2328">row</span><span style="color:#1f2328">.</span>get<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#fff"> </span><span style="color:#1f2328">}</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>score<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u64</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">&lt;</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>player<span style="color:#1f2328">.</span>score<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>show_high_scores<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff"> </span><span style="color:#cf222e">else</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>new_high_score<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre><pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">new_high_score</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>std::io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>print_centered_messages<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">None</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">NEW HIGH SCORE!</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#0550ae">&amp;</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>score<span style="color:#1f2328">.</span>to_string<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#0550ae">&amp;</span><span style="color:#6639ba">format!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff"></span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{}</span><span style="color:#0a3069">{}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">ENTER_YOUR_NAME_MESSAGE</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069"> </span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">.</span>repeat<span style="color:#1f2328">(</span><span style="color:#0550ae">MAX_NAME_LENGTH</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>name<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6639ba">String</span>::new<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>cursor_position: <span style="color:#cf222e">usize</span> <span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>term_width<span style="color:#1f2328">,</span><span style="color:#fff"> </span>term_height<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>terminal::size<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>stdout<span style="color:#1f2328">.</span>execute<span style="color:#1f2328">(</span>MoveTo<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">(</span>term_width<span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">ENTER_YOUR_NAME_MESSAGE</span><span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">MAX_NAME_LENGTH</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">/</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">ENTER_YOUR_NAME_MESSAGE</span><span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>term_height<span style="color:#fff"> </span><span style="color:#0550ae">/</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">3</span><span style="color:#fff"> </span><span style="color:#0550ae">/</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>stdout<span style="color:#1f2328">.</span>write<span style="color:#1f2328">(</span><span style="color:#6639ba">format!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff"></span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>name<span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>as_bytes<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>stdout<span style="color:#1f2328">.</span>execute<span style="color:#1f2328">(</span>cursor::Show<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>stdout<span style="color:#1f2328">.</span>flush<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">loop</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>poll<span style="color:#1f2328">(</span>Duration::from_millis<span style="color:#1f2328">(</span><span style="color:#0550ae">10</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>event<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>read<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>event<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>Event::Key<span style="color:#1f2328">(</span>KeyEvent<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>code<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>state: <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>kind<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>modifiers: <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>kind<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>KeyEventKind::Press<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>code<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span>KeyCode::Backspace<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#57606a">// Handle Backspace key to remove characters.
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#0550ae">!</span>name<span style="color:#1f2328">.</span>is_empty<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#0550ae">&amp;</span><span style="color:#fff"> </span>cursor_position<span style="color:#fff"> </span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#0550ae">0</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>name<span style="color:#1f2328">.</span>remove<span style="color:#1f2328">(</span>cursor_position<span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>cursor_position<span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>stdout<span style="color:#1f2328">.</span>execute<span style="color:#1f2328">(</span>MoveLeft<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>stdout<span style="color:#1f2328">.</span>write<span style="color:#1f2328">(</span><span style="color:#0a3069">b</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069"> </span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>stdout<span style="color:#1f2328">.</span>flush<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span><span style="color:#6639ba">print!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff"></span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span>name<span style="color:#1f2328">[</span>cursor_position<span style="color:#0550ae">..</span><span style="color:#1f2328">]</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>stdout<span style="color:#1f2328">.</span>execute<span style="color:#1f2328">(</span>MoveLeft<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                        </span>name<span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span>cursor_position<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>stdout<span style="color:#1f2328">.</span>flush<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span>KeyCode::Enter<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>conn<span style="color:#1f2328">.</span>execute<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">INSERT INTO high_scores (player_name, score) VALUES (?1, ?2)</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span><span style="color:#6639ba">params!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span>name<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>score<span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#6639ba">execute!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">.</span>lock<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>cursor::Hide<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>show_high_scores<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span>KeyCode::Left<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#57606a">// Move the cursor left.
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>cursor_position<span style="color:#fff"> </span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#0550ae">0</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>stdout<span style="color:#1f2328">.</span>execute<span style="color:#1f2328">(</span>MoveLeft<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>cursor_position<span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span>KeyCode::Right<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#57606a">// Move the cursor right.
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>cursor_position<span style="color:#fff"> </span><span style="color:#0550ae">&lt;</span><span style="color:#fff"> </span>name<span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>stdout<span style="color:#1f2328">.</span>execute<span style="color:#1f2328">(</span>MoveRight<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>cursor_position<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span>KeyCode::Char<span style="color:#1f2328">(</span>c<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>name<span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">&lt;</span><span style="color:#fff"> </span><span style="color:#0550ae">MAX_NAME_LENGTH</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>name<span style="color:#1f2328">.</span>insert<span style="color:#1f2328">(</span>cursor_position<span style="color:#1f2328">,</span><span style="color:#fff"> </span>c<span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>cursor_position<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span><span style="color:#6639ba">print!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff"></span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span>name<span style="color:#1f2328">[</span>cursor_position<span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">]</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>stdout<span style="color:#1f2328">.</span>flush<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span>_<span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span>cursor_position<span style="color:#0550ae">..</span>name<span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                        </span>stdout<span style="color:#1f2328">.</span>execute<span style="color:#1f2328">(</span>MoveLeft<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                    </span>stdout<span style="color:#1f2328">.</span>flush<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span>_<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>_<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<h4 id="pause-and-quit">8. Pause and Quit</h4>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>poll<span style="color:#1f2328">(</span>Duration::from_millis<span style="color:#1f2328">(</span><span style="color:#0550ae">10</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>event<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>read<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>event<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>Event::Key<span style="color:#1f2328">(</span>KeyEvent<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>code<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>state: <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>kind<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>modifiers: <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>kind<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>KeyEventKind::Press<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#1f2328">.</span>clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>code<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>KeyCode::Char<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;p&#39;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>paused<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">!</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>paused<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>KeyCode::Char<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;q&#39;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>handle_quit_event<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>_<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>_<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>render_current_tetromino<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre><pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">handle_pause_event</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>print_centered_messages<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#6639ba">None</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">PAUSED</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">(C)ontinue | (Q)uit</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">]</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">loop</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>poll<span style="color:#1f2328">(</span>Duration::from_millis<span style="color:#1f2328">(</span><span style="color:#0550ae">10</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>event<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>read<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>event<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>Event::Key<span style="color:#1f2328">(</span>KeyEvent<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>code<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>modifiers: <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>kind<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>state: <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>kind<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>KeyEventKind::Press<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>code<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span>KeyCode::Enter<span style="color:#fff"> </span><span style="color:#0550ae">|</span><span style="color:#fff"> </span>KeyCode::Char<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;c&#39;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>render_changed_portions<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>paused<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">false</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#cf222e">break</span><span style="color:#fff"></span><span style="color:#900;font-weight:bold"></span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span>KeyCode::Char<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;q&#39;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span>quit<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span>_<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>_<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre><pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">handle_quit_event</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>print_centered_messages<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#6639ba">None</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">QUIT?</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">(Y)es | (N)o</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">]</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">loop</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>poll<span style="color:#1f2328">(</span>Duration::from_millis<span style="color:#1f2328">(</span><span style="color:#0550ae">10</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>event<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>read<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>event<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>Event::Key<span style="color:#1f2328">(</span>KeyEvent<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>code<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>modifiers: <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>kind<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>state: <span style="color:#1f2328">_</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>kind<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>KeyEventKind::Press<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>code<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span>KeyCode::Enter<span style="color:#fff"> </span><span style="color:#0550ae">|</span><span style="color:#fff"> </span>KeyCode::Char<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;y&#39;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span>quit<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span>KeyCode::Esc<span style="color:#fff"> </span><span style="color:#0550ae">|</span><span style="color:#fff"> </span>KeyCode::Char<span style="color:#1f2328">(</span><span style="color:#0a3069">&#39;n&#39;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>render_changed_portions<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>paused<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">false</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                                </span><span style="color:#cf222e">break</span><span style="color:#fff"></span><span style="color:#900;font-weight:bold"></span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span>_<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>_<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<h4 id="reset">9. Reset</h4>

<p>After the game is over, we can display the highscores table, and allow the player press <code>r</code> to restart:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">reset_game</span><span style="color:#1f2328">(</span>game: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>Game<span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>game<span style="color:#1f2328">.</span>reset<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>game<span style="color:#1f2328">.</span>render<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>game<span style="color:#1f2328">.</span>handle_event<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre><pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">reset</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#57606a">// Reset play grid
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>play_grid<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>create_grid<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">PLAY_WIDTH</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#0550ae">PLAY_HEIGHT</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_with_number_of_filled_lines<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#57606a">// Reset tetrominos
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>current_tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>Tetromino::new<span style="color:#1f2328">(</span><span style="color:#cf222e">false</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>next_tetromino<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>Tetromino::new<span style="color:#1f2328">(</span><span style="color:#cf222e">true</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#57606a">// Reset game statistics
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>lines<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>level<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_at_level<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>score<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>drop_interval: <span style="color:#cf222e">u64</span> <span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">DEFAULT_INTERVAL</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span>_i<span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#0550ae">..=</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_at_level<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>drop_interval<span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>drop_interval<span style="color:#fff"> </span><span style="color:#0550ae">/</span><span style="color:#fff"> </span><span style="color:#0550ae">10</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>drop_interval<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>drop_interval<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#57606a">// Clear any existing messages in the receiver
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#6639ba">Some</span><span style="color:#1f2328">(</span><span style="color:#cf222e">ref</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>receiver<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>receiver<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">while</span><span style="color:#fff"> </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span>_<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>receiver<span style="color:#1f2328">.</span>try_recv<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#57606a">// Resume the game
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>paused<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#cf222e">false</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<h4 id="multiplayer-mode">10. Multiplayer mode</h4>

<p>To make the game more interesting, I want to add the 2-player mode (so I can play with my son). Whenever a player clears some lines, the number of cleared lines will be sent to the competitor.</p>

<p>To do that, first, we need to open a TCP connection between 2 players and then spawn a new thread to receive messages from the competitor:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span>player 1 &lt;--- TCP stream ---&gt; [receive_message thread &lt;--- mpsc::channel --&gt; main thread] player 2
</span></span></code></pre><pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>args<span style="color:#1f2328">.</span>multiplayer<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>args<span style="color:#1f2328">.</span>server_address<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6639ba">None</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>listener<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>TcpListener::bind<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">0.0.0.0:8080</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>my_local_ip<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>local_ip<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">println!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">Server started. Please invite your competitor to connect to </span><span style="color:#0a3069">{}</span><span style="color:#0a3069">.</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6639ba">format!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff"></span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{}</span><span style="color:#0a3069">:8080</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>my_local_ip<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>stream<span style="color:#1f2328">,</span><span style="color:#fff"> </span>_<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>listener<span style="color:#1f2328">.</span>accept<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6639ba">println!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff"></span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">Player 2 connected.</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>stream_clone<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>stream<span style="color:#1f2328">.</span>try_clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>sender<span style="color:#1f2328">,</span><span style="color:#fff"> </span>receiver<span style="color:#1f2328">)</span>: <span style="color:#1f2328">(</span>Sender<span style="color:#0550ae">&lt;</span>MessageType<span style="color:#0550ae">&gt;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>Receiver<span style="color:#0550ae">&lt;</span>MessageType<span style="color:#0550ae">&gt;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>channel<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>game<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>Game::new<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>conn<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6639ba">Some</span><span style="color:#1f2328">(</span>stream<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6639ba">Some</span><span style="color:#1f2328">(</span>receiver<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>args<span style="color:#1f2328">.</span>number_of_lines_already_filled<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>args<span style="color:#1f2328">.</span>level<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>thread::spawn<span style="color:#1f2328">(</span><span style="color:#cf222e">move</span><span style="color:#fff"> </span><span style="color:#0550ae">|</span><span style="color:#0550ae">|</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>receive_message<span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>stream_clone<span style="color:#1f2328">,</span><span style="color:#fff"> </span>sender<span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>game<span style="color:#1f2328">.</span>start<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff"> </span><span style="color:#cf222e">else</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#6639ba">Some</span><span style="color:#1f2328">(</span>server_address<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>args<span style="color:#1f2328">.</span>server_address<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>stream<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>TcpStream::connect<span style="color:#1f2328">(</span>server_address<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>stream_clone<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>stream<span style="color:#1f2328">.</span>try_clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span>sender<span style="color:#1f2328">,</span><span style="color:#fff"> </span>receiver<span style="color:#1f2328">)</span>: <span style="color:#1f2328">(</span>Sender<span style="color:#0550ae">&lt;</span>MessageType<span style="color:#0550ae">&gt;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>Receiver<span style="color:#0550ae">&lt;</span>MessageType<span style="color:#0550ae">&gt;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>channel<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>game<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>Game::new<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>conn<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#6639ba">Some</span><span style="color:#1f2328">(</span>stream<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#6639ba">Some</span><span style="color:#1f2328">(</span>receiver<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>number_of_lines_already_filled<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>start_at_level<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>thread::spawn<span style="color:#1f2328">(</span><span style="color:#cf222e">move</span><span style="color:#fff"> </span><span style="color:#0550ae">|</span><span style="color:#0550ae">|</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>receive_message<span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>stream_clone<span style="color:#1f2328">,</span><span style="color:#fff"> </span>sender<span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>game<span style="color:#1f2328">.</span>start<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<p>When a player receives a message, the sender will forward it to the receiver via the channel:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">receive_message</span><span style="color:#1f2328">(</span>stream: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>TcpStream<span style="color:#1f2328">,</span><span style="color:#fff"> </span>sender: <span style="color:#1f2328">Sender</span><span style="color:#0550ae">&lt;</span>MessageType<span style="color:#0550ae">&gt;</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>buffer<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#cf222e">u8</span><span style="color:#1f2328">;</span><span style="color:#fff"> </span><span style="color:#0550ae">256</span><span style="color:#1f2328">]</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">loop</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>stream<span style="color:#1f2328">.</span>read<span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>buffer<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span>n<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>n<span style="color:#fff"> </span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#0550ae">0</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>msg<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6639ba">String</span>::from_utf8_lossy<span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span>buffer<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#0550ae">..</span>n<span style="color:#1f2328">]</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>msg<span style="color:#1f2328">.</span>starts_with<span style="color:#1f2328">(</span><span style="color:#0550ae">PREFIX_CLEARED_ROWS</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span>rows<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>msg<span style="color:#1f2328">.</span>trim_start_matches<span style="color:#1f2328">(</span><span style="color:#0550ae">PREFIX_CLEARED_ROWS</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>parse<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#6639ba">Err</span><span style="color:#1f2328">(</span>err<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>sender<span style="color:#1f2328">.</span>send<span style="color:#1f2328">(</span>MessageType::ClearedRows<span style="color:#1f2328">(</span>rows<span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#6639ba">eprintln!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff"></span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">Error sending number of cleared rows: </span><span style="color:#0a3069">{}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>err<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#fff"> </span><span style="color:#cf222e">else</span><span style="color:#fff"> </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span>msg<span style="color:#1f2328">.</span>starts_with<span style="color:#1f2328">(</span><span style="color:#0550ae">PREFIX_NOTIFICATION</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>msg<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>msg<span style="color:#1f2328">.</span>trim_start_matches<span style="color:#1f2328">(</span><span style="color:#0550ae">PREFIX_NOTIFICATION</span><span style="color:#1f2328">)</span><span style="color:#1f2328">.</span>to_string<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#6639ba">Err</span><span style="color:#1f2328">(</span>err<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>sender<span style="color:#1f2328">.</span>send<span style="color:#1f2328">(</span>MessageType::Notification<span style="color:#1f2328">(</span>msg<span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#6639ba">eprintln!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff"></span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">Error sending notification message: </span><span style="color:#0a3069">{}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>err<span style="color:#1f2328">)</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6639ba">Ok</span><span style="color:#1f2328">(</span>_<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">|</span><span style="color:#fff"> </span><span style="color:#6639ba">Err</span><span style="color:#1f2328">(</span>_<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">break</span><span style="color:#fff"></span><span style="color:#900;font-weight:bold"></span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<p>On the receiver side, when a player receive a number of cleared lines, it will add the received number of lines (each with an empty cell in a random column) to the bottom of playfield:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#6639ba">Some</span><span style="color:#1f2328">(</span>receiver<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>receiver<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span>message<span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span>receiver<span style="color:#1f2328">.</span>try_iter<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>message<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>MessageType::ClearedRows<span style="color:#1f2328">(</span>rows<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>cells<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">I_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">O_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">S_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">Z_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">T_CELL</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0550ae">L_CELL</span><span style="color:#1f2328">]</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>rng<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>rand::thread_rng<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>random_cell_index<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>rng<span style="color:#1f2328">.</span>gen_range<span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#0550ae">..</span>cells<span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>random_cell<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>cells<span style="color:#1f2328">[</span>random_cell_index<span style="color:#1f2328">]</span><span style="color:#1f2328">.</span>clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span>new_row<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span>random_cell<span style="color:#1f2328">;</span><span style="color:#fff"> </span><span style="color:#0550ae">PLAY_WIDTH</span><span style="color:#1f2328">]</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>random_column<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span>rng<span style="color:#1f2328">.</span>gen_range<span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#0550ae">..</span><span style="color:#0550ae">PLAY_WIDTH</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>new_row<span style="color:#1f2328">[</span>random_column<span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">EMPTY_CELL</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span>_<span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span><span style="color:#0550ae">0</span><span style="color:#0550ae">..</span>rows<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>play_grid<span style="color:#1f2328">.</span>remove<span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>play_grid<span style="color:#1f2328">.</span>insert<span style="color:#1f2328">(</span><span style="color:#0550ae">PLAY_HEIGHT</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>new_row<span style="color:#1f2328">.</span>clone<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>render_play_grid<span style="color:#1f2328">(</span>stdout<span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<p>We also need another component to store the score when playing in 2-player mode:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">struct</span> <span style="color:#1f2328">MultiplayerScore</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>my_score: <span style="color:#cf222e">u8</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span>competitor_score: <span style="color:#cf222e">u8</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#cf222e">fn</span> <span style="color:#6639ba">handle_game_over</span><span style="color:#1f2328">(</span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span>stdout: <span style="color:#cf222e">&amp;</span><span style="color:#1f2328">mut</span><span style="color:#fff"> </span>io::Stdout<span style="color:#1f2328">)</span><span style="color:#fff"> </span>-&gt; <span style="color:#6639ba">Result</span><span style="color:#0550ae">&lt;</span><span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#6639ba">Some</span><span style="color:#1f2328">(</span>stream<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#cf222e">mut</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>stream<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span>send_message<span style="color:#1f2328">(</span>stream<span style="color:#1f2328">,</span><span style="color:#fff"> </span>MessageType::Notification<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">YOU WIN!</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">.</span>to_string<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>multiplayer_score<span style="color:#1f2328">.</span>competitor_score<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>stats_start_x<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_x<span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">STATS_WIDTH</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">DISTANCE</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#6639ba">Some</span><span style="color:#1f2328">(</span>_<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>stream<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#6639ba">execute!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>SetForegroundColor<span style="color:#1f2328">(</span>Color::White<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>SetBackgroundColor<span style="color:#1f2328">(</span>Color::Black<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>SavePosition<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>MoveTo<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>stats_start_x<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">Score: </span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_y<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">10</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>Print<span style="color:#1f2328">(</span><span style="color:#6639ba">format!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{}</span><span style="color:#0a3069"> - </span><span style="color:#0a3069">{}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>multiplayer_score<span style="color:#1f2328">.</span>my_score<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>multiplayer_score<span style="color:#1f2328">.</span>competitor_score<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>ResetColor<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>RestorePosition<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre><pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#6639ba">Some</span><span style="color:#1f2328">(</span>receiver<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>receiver<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span>message<span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span>receiver<span style="color:#1f2328">.</span>try_iter<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">        </span><span style="color:#cf222e">match</span><span style="color:#fff"> </span>message<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">            </span>MessageType::Notification<span style="color:#1f2328">(</span>msg<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#0550ae">&gt;</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>paused<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">!</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>paused<span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span>print_centered_messages<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span>stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#6639ba">None</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#6639ba">vec!</span><span style="color:#fff"></span><span style="color:#1f2328">[</span><span style="color:#0550ae">&amp;</span>msg<span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">(R)estart | (C)ontinue | (Q)uit</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">]</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>multiplayer_score<span style="color:#1f2328">.</span>my_score<span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span>stats_start_x<span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_x<span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">STATS_WIDTH</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">DISTANCE</span><span style="color:#fff"> </span><span style="color:#0550ae">-</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#cf222e">if</span><span style="color:#fff"> </span><span style="color:#cf222e">let</span><span style="color:#fff"> </span><span style="color:#6639ba">Some</span><span style="color:#1f2328">(</span>_<span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">&amp;</span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>stream<span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#6639ba">execute!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>stdout<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>SetForegroundColor<span style="color:#1f2328">(</span>Color::White<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>SetBackgroundColor<span style="color:#1f2328">(</span>Color::Black<span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>SavePosition<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>MoveTo<span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span>stats_start_x<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">2</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">Score: </span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">.</span>len<span style="color:#1f2328">(</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>start_y<span style="color:#fff"> </span><span style="color:#cf222e">as</span><span style="color:#fff"> </span><span style="color:#cf222e">u16</span><span style="color:#fff"> </span><span style="color:#0550ae">+</span><span style="color:#fff"> </span><span style="color:#0550ae">10</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>Print<span style="color:#1f2328">(</span><span style="color:#6639ba">format!</span><span style="color:#fff"></span><span style="color:#1f2328">(</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{}</span><span style="color:#0a3069"> - </span><span style="color:#0a3069">{}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>multiplayer_score<span style="color:#1f2328">.</span>my_score<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                            </span><span style="color:#6a737d">self</span><span style="color:#1f2328">.</span>multiplayer_score<span style="color:#1f2328">.</span>competitor_score<span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span><span style="color:#1f2328">)</span><span style="color:#1f2328">)</span><span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>ResetColor<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                        </span>RestorePosition<span style="color:#1f2328">,</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                    </span><span style="color:#1f2328">)</span><span style="color:#0550ae">?</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">                </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span></code></pre>
<p>Throughout <a href="https://github.com/quantonganh/tetris-tui/">this project</a>, I gained invaluable insights, including:</p>

<ul>
<li>Crafting a cross platform CLI application with <a href="https://docs.rs/crossterm/latest/crossterm/">crossterm</a></li>
<li>Establishing communication between two machines through <a href="https://doc.rust-lang.org/stable/std/net/struct.TcpStream.html">TcpStream</a></li>
<li>Effectively passing data between threads utilizing <a href="https://doc.rust-lang.org/stable/std/sync/mpsc/fn.channel.html">mpsc::channel</a></li>
<li>&hellip;</li>
</ul>

<p>PS: I am currently seeking a new remote software engineering opportunity with a focus on backend development. My flexibility extends accommodating time zones within a range of +/- 3 hours from ICT (Indochina Time). If you have any information regarding companies or positions that are actively hiring for such roles, I would greately approciate it if you can kindly leave a comment or get in touch. Your assistance is sincerely valued. Thank you.</p>


<p>
    Tags:
    
    <a class="btn btn-outline-secondary" href="/tags/rust" role="button">
        <i class="bi bi-tag"></i>
        rust
    </a>
    
    <a class="btn btn-outline-secondary" href="/tags/tetris" role="button">
        <i class="bi bi-tag"></i>
        tetris
    </a>
    
</p>

<div class="d-flex flex-row-reverse">
    <a class="btn btn-outline-info" href="https://github.com/quantonganh/blog/edit/master//posts/2023/10/03/tetris-terminal"
        title="Edit this page on GitHub" target="_blank" rel="noopener">
        <i class="bi bi-pencil"></i>
        Edit on GitHub
    </a>
</div>
<hr />

<table>
    <tr>
        
        <td>
            <div class="d-md-flex">
                <a class="page-link" href="/posts/2025/08/14/jdtls-wrapper">
                    <span aria-hidden="true">&laquo;</span>
                    Previous
                </a>
            </div>
        </td>
        
        
    </tr>
</table>
<script src="https://utteranc.es/client.js" repo="quantonganh/blog" issue-term="pathname" theme="github-light"
    crossorigin="anonymous" async>
    </script>

    
    
  </article>

  <script>
    (function () {
      'use strict';
      window.addEventListener('load', function () {
        let forms = document.getElementsByClassName('needs-validation');
        Array.prototype.filter.call(forms, function (form) {
          form.addEventListener('submit', function (event) {
            if (form.checkValidity() === false) {
              event.preventDefault();
              event.stopPropagation();
            }
            form.classList.add('was-validated');
          }, false);
        });
      }, false);
    })();
  </script>

  <footer class="text-center mt-auto">
    <div class="navi">
      <ul>
        <li>
          <a href="/archives">Archives</a>
        </li>
        <li>
          <a href="/sitemap.xml">Sitemap</a>
        </li>
        <li>
          <a href="/rss.xml">RSS</a>
        </li>
      </ul>
    </div>
  </footer>
</body>

</html>
