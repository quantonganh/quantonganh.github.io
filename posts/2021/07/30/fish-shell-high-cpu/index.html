
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>fish shell - very high CPU usage</title>
  <meta name="description"
    content="Today I learned a new command.">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
    integrity="sha384-tKLJeE1ALTUwtXlaGjJYM3sejfssWdAaWR2s97axw4xkiAdMzQjtOjgcyw0Y50KU" crossorigin="anonymous">
  <link rel="stylesheet" href="/static/css/index.css">
  <link rel="stylesheet" href="/static/css/basic.css">
  <link rel="stylesheet" href="/static/css/grid.css">

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"
    integrity="sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"
    integrity="sha384-YnGSHPPWEUDKMHFPOVmNP7Xyfwx5G0CHet6IoNgiX6CbFZS8gCeIfEgB1MgPwjdI"
    crossorigin="anonymous"></script>
</head>

<body class="d-flex flex-column min-vh-100">
  <article>
    <header class="text-center">
      <div class="title">
        <a href="/">
          <img class="quanface" src="/static/images/quanface.png" />
          Quan Tong
        </a>
      </div>
      <i>"Life is all about sharing. If we are good at something, pass it on." - Mary Berry</i>
      <div class="navi">
        <ul>
          <li>
            <a href="/about">About</a>
          </li>
          <li>
            <a href="/projects">Projects</a>
          </li>
          <li>
            <a href="/photos">Photos</a>
          </li>
          <li>
            <a class="dropdown-toggle" href="#" role="button" id="categoriesMenuLink" data-toggle="dropdown"
              aria-haspopup="true" aria-expanded="false">
              Categories
            </a>

            <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
              
              <a class="dropdown-item" href="/categories/Cu%e1%bb%99c%20s%e1%bb%91ng">Cuộc sống (12)</a>
              
              <a class="dropdown-item" href="/categories/DevOps">DevOps (19)</a>
              
              <a class="dropdown-item" href="/categories/Development%20Environment">Development Environment (15)</a>
              
              <a class="dropdown-item" href="/categories/Du%20l%e1%bb%8bch">Du lịch (11)</a>
              
              <a class="dropdown-item" href="/categories/Networking">Networking (4)</a>
              
              <a class="dropdown-item" href="/categories/Operating%20System">Operating System (1)</a>
              
              <a class="dropdown-item" href="/categories/Programming">Programming (30)</a>
              
            </div>
          </li>
          <li>
            <a href="/tags">Tags</a>
          </li>
        </ul>
      </div>
    </header>
    <hr>
    
<h3>fish shell - very high CPU usage</h3>
<p class="text-secondary">2021-07-30</p>

<p>
    Categories:
    
    <a class="btn btn-outline-primary" href="/categories/Operating%20System" role="button">Operating System</a>
    
</p>

<p>Sometimes my Macbook is loud like a plow, and the culprit is usually <a href="https://github.com/docker/for-mac/issues?q=high+cpu">docker</a>. This time it&rsquo;s different, <code>top -u</code> tells me that <a href="https://fishshell.com/">fish shell</a> is taking up &gt; 100% CPU.</p>

<p>I just switched from <a href="https://github.com/zsh-users/zsh">zsh</a> to <a href="https://github.com/fish-shell/fish-shell">fish</a> about a year ago after having problems with <a href="https://stackoverflow.com/questions/62766815/git-completion-in-zsh-git-func-wrap3-not-found">git completion</a>.</p>

<p>My favorite feature about fish is probably <a href="https://fishshell.com/docs/current/tutorial.html#autosuggestions">autosuggestions</a>. Normally, when I want to run a command again, I can <code>control+R</code>, type a few letters to select the command I want to run. With fish shell, I can type that command and then <code>-&gt;</code> or <code>control+F</code> is fine.</p>

<p>Going back to the problem above, trying to search through Google I found: <a href="https://github.com/fish-shell/fish-shell/issues/6353#issuecomment-558360629">https://github.com/fish-shell/fish-shell/issues/6353#issuecomment-558360629</a></p>

<p>I run the command <code>sample</code> and the result is:</p>
<pre style="background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="display:flex;"><span>Analysis of sampling fish <span style="color:#0550ae">(</span>pid 26885<span style="color:#0550ae">)</span> every <span style="color:#0550ae">1</span> millisecond
</span></span><span style="display:flex;"><span>Process:         fish <span style="color:#0550ae">[</span>26885<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>Path:            /usr/local/Cellar/fish/3.2.1/bin/fish
</span></span><span style="display:flex;"><span>Load Address:    0x107c0a000
</span></span><span style="display:flex;"><span>Identifier:      fish
</span></span><span style="display:flex;"><span>Version:         <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>Code Type:       X86-64
</span></span><span style="display:flex;"><span>Parent Process:  ??? <span style="color:#0550ae">[</span>26884<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Date/Time:       2021-07-30 16:06:09.188 +0700
</span></span><span style="display:flex;"><span>Launch Time:     2021-07-30 15:21:06.317 +0700
</span></span><span style="display:flex;"><span>OS Version:      Mac OS X 10.15.7 <span style="color:#0550ae">(</span>19H1030<span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>Report Version:  <span style="color:#0550ae">7</span>
</span></span><span style="display:flex;"><span>Analysis Tool:   /usr/bin/sample
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Physical footprint:         17.6M
</span></span><span style="display:flex;"><span>Physical footprint <span style="color:#0550ae">(</span>peak<span style="color:#0550ae">)</span>:  24.6M
</span></span><span style="display:flex;"><span>----
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Call graph:
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">4468</span> Thread_16282782   DispatchQueue_1: com.apple.main-thread  <span style="color:#0550ae">(</span>serial<span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    + <span style="color:#0550ae">4468</span> start  <span style="color:#0550ae">(</span>in libdyld.dylib<span style="color:#0550ae">)</span> + <span style="color:#0550ae">1</span>  <span style="color:#0550ae">[</span>0x7fff6ba11cc9<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +   <span style="color:#0550ae">4468</span> main  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">5708</span>  <span style="color:#0550ae">[</span>0x107c0d668<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +     <span style="color:#0550ae">4468</span> reader_read<span style="color:#0550ae">(</span>parser_t<span style="color:#1f2328">&amp;</span>, int, io_chain_t const<span style="color:#1f2328">&amp;</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">1467</span>  <span style="color:#0550ae">[</span>0x107cd76d0<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +       <span style="color:#0550ae">4468</span> parser_t::eval<span style="color:#0550ae">(</span>std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt; const<span style="color:#1f2328">&amp;</span>, io_chain_t const<span style="color:#1f2328">&amp;</span>, std::__1::shared_ptr&lt;job_gr
</span></span><span style="display:flex;"><span>oup_t&gt; const<span style="color:#1f2328">&amp;</span>, block_type_t<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">126</span>  <span style="color:#0550ae">[</span>0x107cbe684<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +         <span style="color:#0550ae">4468</span> parser_t::eval<span style="color:#0550ae">(</span>std::__1::shared_ptr&lt;parsed_source_t const&gt; const<span style="color:#1f2328">&amp;</span>, io_chain_t const<span style="color:#1f2328">&amp;</span>, std::__1::shared_ptr&lt;job_group_t&gt; const<span style="color:#1f2328">&amp;</span>, block_type_t<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">48</span>  <span style="color:#0550ae">[</span>0x
</span></span><span style="display:flex;"><span>107cbe7f4<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +           <span style="color:#0550ae">4468</span> eval_res_t parser_t::eval_node&lt;ast::job_list_t&gt;<span style="color:#0550ae">(</span>std::__1::shared_ptr&lt;parsed_source_t const&gt; const<span style="color:#1f2328">&amp;</span>, ast::job_list_t const<span style="color:#1f2328">&amp;</span>, io_chain_t const<span style="color:#1f2328">&amp;</span>, std::__1::shared_
</span></span><span style="display:flex;"><span>ptr&lt;job_group_t&gt; const<span style="color:#1f2328">&amp;</span>, block_type_t<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">939</span>  <span style="color:#0550ae">[</span>0x107cbef65<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +             <span style="color:#0550ae">4468</span> parse_execution_context_t::eval_node<span style="color:#0550ae">(</span>ast::job_list_t const<span style="color:#1f2328">&amp;</span>, block_t const*<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">203</span>  <span style="color:#0550ae">[</span>0x107cb4c67<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +               <span style="color:#0550ae">4468</span> parse_execution_context_t::run_job_list<span style="color:#0550ae">(</span>ast::job_list_t const<span style="color:#1f2328">&amp;</span>, block_t const*<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">59</span>  <span style="color:#0550ae">[</span>0x107caf237<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                 <span style="color:#0550ae">4468</span> parse_execution_context_t::run_job_conjunction<span style="color:#0550ae">(</span>ast::job_conjunction_t const<span style="color:#1f2328">&amp;</span>, block_t const*<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">80</span>  <span style="color:#0550ae">[</span>0x107caf0bc<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                   <span style="color:#0550ae">4468</span> parse_execution_context_t::run_1_job<span style="color:#0550ae">(</span>ast::job_t const<span style="color:#1f2328">&amp;</span>, block_t const*<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">1875</span>  <span style="color:#0550ae">[</span>0x107cb460b<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                     <span style="color:#0550ae">4468</span> exec_job<span style="color:#0550ae">(</span>parser_t<span style="color:#1f2328">&amp;</span>, std::__1::shared_ptr&lt;job_t&gt; const<span style="color:#1f2328">&amp;</span>, io_chain_t const<span style="color:#1f2328">&amp;</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">2383</span>  <span style="color:#0550ae">[</span>0x107c7670a<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                       <span style="color:#0550ae">4468</span> job_t::continue_job<span style="color:#0550ae">(</span>parser_t<span style="color:#1f2328">&amp;</span>, bool<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">986</span>  <span style="color:#0550ae">[</span>0x107cc889e<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                         <span style="color:#0550ae">4468</span> process_mark_finished_children<span style="color:#0550ae">(</span>parser_t<span style="color:#1f2328">&amp;</span>, bool<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">428</span>  <span style="color:#0550ae">[</span>0x107cc6684<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                           <span style="color:#0550ae">4468</span> topic_monitor_t::check<span style="color:#0550ae">(</span>generation_list_t*, bool<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">379</span>  <span style="color:#0550ae">[</span>0x107ce60bd<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                             <span style="color:#0550ae">4468</span> topic_monitor_t::await_gens<span style="color:#0550ae">(</span>generation_list_t const<span style="color:#1f2328">&amp;</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">199</span>  <span style="color:#0550ae">[</span>0x107ce5da1<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                               <span style="color:#0550ae">4468</span> binary_semaphore_t::wait<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">76</span>  <span style="color:#0550ae">[</span>0x107ce55cc<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                                 <span style="color:#0550ae">4468</span> <span style="color:#6639ba">read</span>  <span style="color:#0550ae">(</span>in libsystem_kernel.dylib<span style="color:#0550ae">)</span> + <span style="color:#0550ae">10</span>  <span style="color:#0550ae">[</span>0x7fff6bb5381e<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0550ae">4468</span> Thread_16286348
</span></span><span style="display:flex;"><span>    + <span style="color:#0550ae">4468</span> thread_start  <span style="color:#0550ae">(</span>in libsystem_pthread.dylib<span style="color:#0550ae">)</span> + <span style="color:#0550ae">15</span>  <span style="color:#0550ae">[</span>0x7fff6bc11b8b<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +   <span style="color:#0550ae">4468</span> _pthread_start  <span style="color:#0550ae">(</span>in libsystem_pthread.dylib<span style="color:#0550ae">)</span> + <span style="color:#0550ae">148</span>  <span style="color:#0550ae">[</span>0x7fff6bc16109<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +     <span style="color:#0550ae">4468</span> thread_pool_t::run_trampoline<span style="color:#0550ae">(</span>void*<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">14</span>  <span style="color:#0550ae">[</span>0x107ca6442<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +       <span style="color:#0550ae">4468</span> thread_pool_t::run<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">243</span>  <span style="color:#0550ae">[</span>0x107ca6187<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +         <span style="color:#0550ae">4468</span> std::__1::__function::__func&lt;debounce_t::perform_impl<span style="color:#0550ae">(</span>std::__1::function&lt;void <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;, std::__1::function&lt;void <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;<span style="color:#0550ae">)</span>::<span style="color:#953800">$_0</span>, std::__1::allocator&lt;debounce_t::perform_impl<span style="color:#0550ae">(</span>std::__1::function&lt;void <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;, std::__1::function&lt;void <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;<span style="color:#0550ae">)</span>::<span style="color:#953800">$_0</span>&gt;, void <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;::operator<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span><span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">22</span>  <span style="color:#0550ae">[</span>0x107ca8188<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +           <span style="color:#0550ae">4468</span> debounce_t::impl_t::run_next<span style="color:#0550ae">(</span>unsigned long long<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">251</span>  <span style="color:#0550ae">[</span>0x107ca7079<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +             <span style="color:#0550ae">4468</span> std::__1::__function::__func&lt;iothread_trampoline_t&lt;std::__1::function&lt;<span style="color:#0550ae">(</span>anonymous namespace<span style="color:#0550ae">)</span>::highlight_result_t <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;, reader_data_t::super_highlight_me_plenty<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>::<span style="color:#953800">$_2</span>, <span style="color:#0550ae">(</span>anonymous namespace<span style="color:#0550ae">)</span>::highlight_result_t&gt;::iothread_trampoline_t<span style="color:#0550ae">(</span>std::__1::function&lt;<span style="color:#0550ae">(</span>anonymous namespace<span style="color:#0550ae">)</span>::highlight_result_t <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt; const<span style="color:#1f2328">&amp;</span>, reader_data_t::super_highlight_me_plenty<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>::<span style="color:#953800">$_2</span> const<span style="color:#1f2328">&amp;</span><span style="color:#0550ae">)</span>::<span style="color:#0a3069">&#39;lambda&#39;</span><span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>, std::__1::allocator&lt;iothread_trampoline_t&lt;std::__1::function&lt;<span style="color:#0550ae">(</span>anonymous namespace<span style="color:#0550ae">)</span>::highlight_result_t <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;, reader_data_t::super_highlight_me_plenty<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>::<span style="color:#953800">$_2</span>, <span style="color:#0550ae">(</span>anonymous namespace<span style="color:#0550ae">)</span>::highlight_result_t&gt;::iothread_trampoline_t<span style="color:#0550ae">(</span>std::__1::function&lt;<span style="color:#0550ae">(</span>anonymous namespace<span style="color:#0550ae">)</span>::highlight_result_t <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt; const<span style="color:#1f2328">&amp;</span>, reader_data_t::super_highlight_me_plenty<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>::<span style="color:#953800">$_2</span> const<span style="color:#1f2328">&amp;</span><span style="color:#0550ae">)</span>::<span style="color:#0a3069">&#39;lambda&#39;</span><span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;, void <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;::operator<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span><span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">42</span>  <span style="color:#0550ae">[</span>0x107cdb7c0<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +               <span style="color:#0550ae">4468</span> std::__1::__function::__func&lt;get_highlight_performer<span style="color:#0550ae">(</span>parser_t<span style="color:#1f2328">&amp;</span>, std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt; const<span style="color:#1f2328">&amp;</span>, bool<span style="color:#0550ae">)</span>::<span style="color:#953800">$_8</span>, std::__1::allocator&lt;get_highlight_performer<span style="color:#0550ae">(</span>parser_t<span style="color:#1f2328">&amp;</span>, std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt; const<span style="color:#1f2328">&amp;</span>, bool<span style="color:#0550ae">)</span>::<span style="color:#953800">$_8</span>&gt;, <span style="color:#0550ae">(</span>anonymous namespace<span style="color:#0550ae">)</span>::highlight_result_t <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;::operator<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span><span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">250</span>  <span style="color:#0550ae">[</span>0x107cd9594<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                 <span style="color:#0550ae">4468</span> highlight_shell<span style="color:#0550ae">(</span>std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt; const<span style="color:#1f2328">&amp;</span>, std::__1::vector&lt;highlight_spec_t, std::__1::allocator&lt;highlight_spec_t&gt; &gt;<span style="color:#1f2328">&amp;</span>, operation_context_t const<span style="color:#1f2328">&amp;</span>, bool<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">180</span>  <span style="color:#0550ae">[</span>0x107c898bd<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                   <span style="color:#0550ae">4468</span> highlighter_t::highlight<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">607</span>  <span style="color:#0550ae">[</span>0x107c87f45<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                     <span style="color:#0550ae">4468</span> is_potential_path<span style="color:#0550ae">(</span>std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt; const<span style="color:#1f2328">&amp;</span>, std::__1::vector&lt;std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt;, std::__1::allocator&lt;std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt; &gt; &gt; const<span style="color:#1f2328">&amp;</span>, operation_context_t const<span style="color:#1f2328">&amp;</span>, unsigned int<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">1483</span>  <span style="color:#0550ae">[</span>0x107c8634f<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                       <span style="color:#0550ae">4468</span> wdirname<span style="color:#0550ae">(</span>std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt; const<span style="color:#1f2328">&amp;</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">62</span>  <span style="color:#0550ae">[</span>0x107cee081<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                         <span style="color:#0550ae">4468</span> str2wcstring<span style="color:#0550ae">(</span>char const*<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">21</span>  <span style="color:#0550ae">[</span>0x107c4d709<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>    +                           <span style="color:#0550ae">4468</span> _platform_strlen  <span style="color:#0550ae">(</span>in libsystem_platform.dylib<span style="color:#0550ae">)</span> + <span style="color:#0550ae">18</span>  <span style="color:#0550ae">[</span>0x7fff6bc07e52<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Total number in stack <span style="color:#0550ae">(</span>recursive counted multiple, when &gt;<span style="color:#0550ae">=</span>5<span style="color:#0550ae">)</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">9</span>       _platform_strlen  <span style="color:#0550ae">(</span>in libsystem_platform.dylib<span style="color:#0550ae">)</span> + <span style="color:#0550ae">0</span>  <span style="color:#0550ae">[</span>0x7fff6bc07e40<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">9</span>       _pthread_start  <span style="color:#0550ae">(</span>in libsystem_pthread.dylib<span style="color:#0550ae">)</span> + <span style="color:#0550ae">148</span>  <span style="color:#0550ae">[</span>0x7fff6bc16109<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">9</span>       debounce_t::impl_t::run_next<span style="color:#0550ae">(</span>unsigned long long<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">251</span>  <span style="color:#0550ae">[</span>0x107ca7079<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">9</span>       highlight_shell<span style="color:#0550ae">(</span>std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt; const<span style="color:#1f2328">&amp;</span>, std::__1::vector&lt;highlight_spec_t, std::__1::allocator&lt;highlight_spec_t&gt; &gt;<span style="color:#1f2328">&amp;</span>, operation_context_t const<span style="color:#1f2328">&amp;</span>, bool<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">180</span>  <span style="color:#0550ae">[</span>0x107c898bd<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">9</span>       highlighter_t::highlight<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">607</span>  <span style="color:#0550ae">[</span>0x107c87f45<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">9</span>       is_potential_path<span style="color:#0550ae">(</span>std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt; const<span style="color:#1f2328">&amp;</span>, std::__1::vector&lt;std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt;, std::__1::allocator&lt;std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt; &gt; &gt; const<span style="color:#1f2328">&amp;</span>, operation_context_t const<span style="color:#1f2328">&amp;</span>, unsigned int<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">1483</span>  <span style="color:#0550ae">[</span>0x107c8634f<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">9</span>       std::__1::__function::__func&lt;debounce_t::perform_impl<span style="color:#0550ae">(</span>std::__1::function&lt;void <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;, std::__1::function&lt;void <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;<span style="color:#0550ae">)</span>::<span style="color:#953800">$_0</span>, std::__1::allocator&lt;debounce_t::perform_impl<span style="color:#0550ae">(</span>std::__1::function&lt;void <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;, std::__1::function&lt;void <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;<span style="color:#0550ae">)</span>::<span style="color:#953800">$_0</span>&gt;, void <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;::operator<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span><span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">22</span>  <span style="color:#0550ae">[</span>0x107ca8188<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">9</span>       std::__1::__function::__func&lt;get_highlight_performer<span style="color:#0550ae">(</span>parser_t<span style="color:#1f2328">&amp;</span>, std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt; const<span style="color:#1f2328">&amp;</span>, bool<span style="color:#0550ae">)</span>::<span style="color:#953800">$_8</span>, std::__1::allocator&lt;get_highlight_performer<span style="color:#0550ae">(</span>parser_t<span style="color:#1f2328">&amp;</span>, std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt; const<span style="color:#1f2328">&amp;</span>, bool<span style="color:#0550ae">)</span>::<span style="color:#953800">$_8</span>&gt;, <span style="color:#0550ae">(</span>anonymous namespace<span style="color:#0550ae">)</span>::highlight_result_t <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;::operator<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span><span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">250</span>  <span style="color:#0550ae">[</span>0x107cd9594<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">9</span>       std::__1::__function::__func&lt;iothread_trampoline_t&lt;std::__1::function&lt;<span style="color:#0550ae">(</span>anonymous namespace<span style="color:#0550ae">)</span>::highlight_result_t <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;, reader_data_t::super_highlight_me_plenty<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>::<span style="color:#953800">$_2</span>, <span style="color:#0550ae">(</span>anonymous namespace<span style="color:#0550ae">)</span>::highlight_result_t&gt;::iothread_trampoline_t<span style="color:#0550ae">(</span>std::__1::function&lt;<span style="color:#0550ae">(</span>anonymous namespace<span style="color:#0550ae">)</span>::highlight_result_t <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt; const<span style="color:#1f2328">&amp;</span>, reader_data_t::super_highlight_me_plenty<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>::<span style="color:#953800">$_2</span> const<span style="color:#1f2328">&amp;</span><span style="color:#0550ae">)</span>::<span style="color:#0a3069">&#39;lambda&#39;</span><span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>, std::__1::allocator&lt;iothread_trampoline_t&lt;std::__1::function&lt;<span style="color:#0550ae">(</span>anonymous namespace<span style="color:#0550ae">)</span>::highlight_result_t <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;, reader_data_t::super_highlight_me_plenty<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>::<span style="color:#953800">$_2</span>, <span style="color:#0550ae">(</span>anonymous namespace<span style="color:#0550ae">)</span>::highlight_result_t&gt;::iothread_trampoline_t<span style="color:#0550ae">(</span>std::__1::function&lt;<span style="color:#0550ae">(</span>anonymous namespace<span style="color:#0550ae">)</span>::highlight_result_t <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt; const<span style="color:#1f2328">&amp;</span>, reader_data_t::super_highlight_me_plenty<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>::<span style="color:#953800">$_2</span> const<span style="color:#1f2328">&amp;</span><span style="color:#0550ae">)</span>::<span style="color:#0a3069">&#39;lambda&#39;</span><span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;, void <span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>&gt;::operator<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span><span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">42</span>  <span style="color:#0550ae">[</span>0x107cdb7c0<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">9</span>       str2wcstring<span style="color:#0550ae">(</span>char const*<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">21</span>  <span style="color:#0550ae">[</span>0x107c4d709<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">9</span>       thread_pool_t::run<span style="color:#0550ae">(</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">243</span>  <span style="color:#0550ae">[</span>0x107ca6187<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">9</span>       thread_pool_t::run_trampoline<span style="color:#0550ae">(</span>void*<span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">14</span>  <span style="color:#0550ae">[</span>0x107ca6442<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">9</span>       thread_start  <span style="color:#0550ae">(</span>in libsystem_pthread.dylib<span style="color:#0550ae">)</span> + <span style="color:#0550ae">15</span>  <span style="color:#0550ae">[</span>0x7fff6bc11b8b<span style="color:#0550ae">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0550ae">9</span>       wdirname<span style="color:#0550ae">(</span>std::__1::basic_string&lt;wchar_t, std::__1::char_traits&lt;wchar_t&gt;, std::__1::allocator&lt;wchar_t&gt; &gt; const<span style="color:#1f2328">&amp;</span><span style="color:#0550ae">)</span>  <span style="color:#0550ae">(</span>in fish<span style="color:#0550ae">)</span> + <span style="color:#0550ae">62</span>  <span style="color:#0550ae">[</span>0x107cee081<span style="color:#0550ae">]</span>
</span></span></code></pre>
<p><em>(Honestly, I&rsquo;ve been using Mac for almost 8 years and this is the first time I&rsquo;ve heard of the <code>sample</code> command.)</em></p>

<p>I&rsquo;m not familiar with these stack trace, but it seems to be recursive. Looking more closely on GitHub, I found: <a href="https://github.com/fish-shell/fish-shell/issues/7837#issuecomment-803664453">https://github.com/fish-shell/fish-shell/issues/7837#issuecomment-803664453</a></p>

<p>Allow me to quote the explanation of <a href="https://github.com/ridiculousfish">ridiculousfish</a>:</p>

<blockquote>
<p>Ugh, this is bad. There&rsquo;s two issues: dirname is failing and SIGSEGV is being dropped; both are Mac/BSD specific.</p>

<p>Syntax highlighting tries to determine which arguments may be valid paths, so it can underline them. We pass the string to dirname to get its parent. I believed dirname merely trims the string from the last slash, which is correct on Linux: it cannot error. But on Mac dirname copies the string to internal storage, and will error if the string exceeds PATH_MAX, in which case it returns null.</p>

<p>So we try to construct a std::string from null and this produces a SIGSEGV. I had thought that if a thread triggered SIGSEGV, the signal would be delivered somewhere (e.g. to the main thread) or else the program would be terminated, and again on Linux this is correct. But on Mac the signal is just dropped; the thread then repeats and gets another SIGSEGV, leading to the infinite loop.</p>

<p>Fixes need to be:</p>

<p>_ Don&rsquo;t block the four error signals (SIGBUS, SIGFPE, SIGILL, or SIGSEGV) in background threads. This would allow fish to crash on Mac.</p>

<p>_ Stop using system provided dirname, it&rsquo;s a big footgun</p>

<p>_ Optimization: skip path detection for arguments of length &gt; PATH_MAX.</p>
</blockquote>


<p>
    Tags:
    
    <a class="btn btn-outline-secondary" href="/tags/osx" role="button">
        <i class="bi bi-tag"></i>
        osx
    </a>
    
    <a class="btn btn-outline-secondary" href="/tags/fish" role="button">
        <i class="bi bi-tag"></i>
        fish
    </a>
    
    <a class="btn btn-outline-secondary" href="/tags/sample" role="button">
        <i class="bi bi-tag"></i>
        sample
    </a>
    
</p>

<div class="d-flex flex-row-reverse">
    <a class="btn btn-outline-info" href="https://github.com/quantonganh/blog/edit/master//posts/2021/07/30/fish-shell-high-cpu"
        title="Edit this page on GitHub" target="_blank" rel="noopener">
        <i class="bi bi-pencil"></i>
        Edit on GitHub
    </a>
</div>
<hr />

<table>
    <tr>
        
        <td>
            <div class="d-md-flex">
                <a class="page-link" href="/posts/2025/08/14/jdtls-wrapper">
                    <span aria-hidden="true">&laquo;</span>
                    Previous
                </a>
            </div>
        </td>
        
        
    </tr>
</table>
<script src="https://utteranc.es/client.js" repo="quantonganh/blog" issue-term="pathname" theme="github-light"
    crossorigin="anonymous" async>
    </script>

    
    
  </article>

  <script>
    (function () {
      'use strict';
      window.addEventListener('load', function () {
        let forms = document.getElementsByClassName('needs-validation');
        Array.prototype.filter.call(forms, function (form) {
          form.addEventListener('submit', function (event) {
            if (form.checkValidity() === false) {
              event.preventDefault();
              event.stopPropagation();
            }
            form.classList.add('was-validated');
          }, false);
        });
      }, false);
    })();
  </script>

  <footer class="text-center mt-auto">
    <div class="navi">
      <ul>
        <li>
          <a href="/archives">Archives</a>
        </li>
        <li>
          <a href="/sitemap.xml">Sitemap</a>
        </li>
        <li>
          <a href="/rss.xml">RSS</a>
        </li>
      </ul>
    </div>
  </footer>
</body>

</html>
